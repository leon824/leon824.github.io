<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-hk">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/xiongmao.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/xiongmao.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="人们常常嘲笑“螳臂当车” 但有时候啊，你并不是驾车的人 正巧是那只，反抗不了的螳螂。">
<meta property="og:type" content="website">
<meta property="og:title" content="花谢花开">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="花谢花开">
<meta property="og:description" content="人们常常嘲笑“螳臂当车” 但有时候啊，你并不是驾车的人 正巧是那只，反抗不了的螳螂。">
<meta property="og:locale" content="zh-hk">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="花谢花开">
<meta name="twitter:description" content="人们常常嘲笑“螳臂当车” 但有时候啊，你并不是驾车的人 正巧是那只，反抗不了的螳螂。">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":true},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>花谢花开</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-hk">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">花谢花开</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首頁
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            歸檔
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/18/elk集群搭建/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="leonyoung">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://res.cloudinary.com/leon824/image/upload/v1505793001/IMG_3957_uwrsum.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="花谢花开">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/18/elk集群搭建/" itemprop="url">centos搭建ELK集群</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              
              <time title="創建於" itemprop="dateCreated datePublished" datetime="2019-04-18T19:22:37+08:00">
                2019-04-18
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/elk/" itemprop="url" rel="index">
                    <span itemprop="name">elk</span>
                  </a>
                </span>

                
                
              
            </span>
          

          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字數統計&#58;</span>
                
                <span title="字數統計">
                  2,886
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">閱讀時長 &asymp;</span>
                
                <span title="閱讀時長">
                  13
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="centos搭建ELK集群"><a href="#centos搭建ELK集群" class="headerlink" title=" centos搭建ELK集群"></a><center> centos搭建ELK集群</center></h1><blockquote>
<p>在之前两篇文章中我们详细讲述了如何在一台机器中搭建Filebeat + ELK单点服务，但是ELK服务若是上生产，为了实现高可用，我们需要搭建分布式集群。</p>
</blockquote>
<p>   集群架构图：<br>   <img src="https://res.cloudinary.com/leon824/image/upload/v1555588911/elk_xitdtn.png" alt=""><br>整个集群的部署是在下面这三台中的，机器ip<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">172.20.0.203</div><div class="line">172.30.0.199</div><div class="line">172.17.71.113</div></pre></td></tr></table></figure></p>
<p>根据个人这些年搭建各种集群的经验来说，想要快速完成集群搭建，我们一定要注意控制<strong>”变量“</strong>，也就是说我们完成一个模块的配置之后要快速验证当前这一个模块是否配置正常，不要着急去配置后边的模块，若是出现问题，这样可能会导致后边难以定位具体问题出现在哪里，白白浪费时间，切记切记。</p>
<h3 id="集群配置免密登录"><a href="#集群配置免密登录" class="headerlink" title="集群配置免密登录"></a>集群配置免密登录</h3><h5 id="1、先在各个环境中生成秘钥对。"><a href="#1、先在各个环境中生成秘钥对。" class="headerlink" title="1、先在各个环境中生成秘钥对。"></a>1、先在各个环境中生成秘钥对。</h5><p>下面的指令需要在各个环境中执行，生成对应的公私钥</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> ssh-keygen -t rsa</div></pre></td></tr></table></figure>
<h5 id="2、-将各个环境中的公钥全部集中到一个authorized-keys文件中"><a href="#2、-将各个环境中的公钥全部集中到一个authorized-keys文件中" class="headerlink" title="2、 将各个环境中的公钥全部集中到一个authorized_keys文件中"></a>2、 将各个环境中的公钥全部集中到一个<code>authorized_keys</code>文件中</h5><h5 id="3、然后将这个文件分发到各个机器的-ssh目录下面。"><a href="#3、然后将这个文件分发到各个机器的-ssh目录下面。" class="headerlink" title="3、然后将这个文件分发到各个机器的.ssh目录下面。"></a>3、然后将这个文件分发到各个机器的.ssh目录下面。</h5><p>上述操作步骤并不复杂，但是在实际操作中需要注意一些地方，下面举例需要特别注意的地方。</p>
<h5 id="可能会出现的问题-："><a href="#可能会出现的问题-：" class="headerlink" title="可能会出现的问题 ："></a>可能会出现的问题 ：</h5><p>a，不要忘记修改sshd服务的配置。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">RSAAuthentication yes</div><div class="line">PubkeyAuthentication yes</div><div class="line">AuthorizedKeysFile      /home/felk/.ssh/authorized_keys</div></pre></td></tr></table></figure></p>
<p>然后重启sshd服务<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> sudo service sshd restart</div></pre></td></tr></table></figure></p>
<p>特别是最后一个配置涉及到<code>authorized_keys</code>文件的目录，需要根据自己的实际配置目录添加进去。</p>
<p>b、<code>ssh_exchange_identification: Connection closed by remote host</code>报错</p>
<p>解决办法：<br>先登录到需要目标机器中查看 <code>/etc/hosts.allow</code>文件中是否允许响应网段ip访问。修改之后重启sshd服务。</p>
<p>主要就是上边的两个问题。</p>
<h3 id="配置zookeeper集群"><a href="#配置zookeeper集群" class="headerlink" title="配置zookeeper集群"></a>配置zookeeper集群</h3><p>由于我们的架构中使用到了kafka，kafka集群是需要zookeeper集群来管理的，所以在安装kafka之前需要安装zk集群。</p>
<p>1、先在三台机器中zk目录的根目录下分别创两个目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ mkdir logs</div><div class="line">$ mkdir data</div></pre></td></tr></table></figure>
<p>2、然后分别在data目录中创建一个<code>myid</code>文件，这个文件里边只有一个数字，代表当前zk服务的标记，三个zookeeper模块中的myid文件中的内容必须保证不同。<br>3、进入zk的conf目录，创建一个名为zoo.cfg的文件，填入以下内容</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">tickTime=2000</div><div class="line">initLimit=10</div><div class="line">syncLimit=5</div><div class="line">dataDir=/opt/soft/zookeeper/data</div><div class="line">dataLogDir=/opt/soft/zookeeper/logs</div><div class="line">clientPort=2181</div><div class="line">server.0=172.20.0.203:2888:3888</div><div class="line">server.1=172.30.0.199:2888:3888</div><div class="line">server.2=172.17.71.113:2888:3888</div></pre></td></tr></table></figure>
<p>需要注意最后三行配置，server.0、server.1、server.2中的0、1、2就是之前你创建myid文件中写入的值。</p>
<p>然后将文件分发到各个服务器中。</p>
<p>为了方便使用，我们可以在配置文件中加入zookeeper的环境变量。</p>
<p>然后在三台机器中分别执行<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> zkServer.sh start</div></pre></td></tr></table></figure></p>
<p>启动完成后分别执行<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">[felk@blv0104 conf]$ zkServer.sh status</div><div class="line">JMX enabled by default</div><div class="line">Using config: /opt/soft/zookeeper/bin/../conf/zoo.cfg</div><div class="line">Mode: follower</div><div class="line"></div><div class="line">[felk@blv0114 conf]$ zkServer.sh status</div><div class="line">JMX enabled by default</div><div class="line">Using config: /opt/soft/zookeeper/bin/../conf/zoo.cfg</div><div class="line">Mode: leader</div><div class="line"></div><div class="line">[felk@blv0115 es]$ zkServer.sh status</div><div class="line">JMX enabled by default</div><div class="line">Using config: /opt/soft/zookeeper/bin/../conf/zoo.cfg</div><div class="line">Mode: follower</div></pre></td></tr></table></figure></p>
<p>若出现上面的的信息，则说明配置正确。</p>
<h3 id="配置kafka集群"><a href="#配置kafka集群" class="headerlink" title="配置kafka集群"></a>配置kafka集群</h3><p>1、分别进入kakfa的目录，在根目录下面创建一个<code>logs</code>的目录。</p>
<p>2、进入<code>config</code>目录，编辑<code>server.properties</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span> kafka-1</div><div class="line"><span class="meta">#</span>注意和集群中其他机器不同</div><div class="line">broker.id=0     </div><div class="line">listeners=PLAINTEXT://172.20.0.203:9092</div><div class="line"><span class="meta"> #</span>当前机器的ip</div><div class="line">advertised.host.name=172.20.0.203  </div><div class="line">num.network.threads=3</div><div class="line">num.io.threads=8</div><div class="line">socket.send.buffer.bytes=102400</div><div class="line">socket.receive.buffer.bytes=102400</div><div class="line">socket.request.max.bytes=104857600</div><div class="line">log.dirs=/opt/soft/kafka/logs</div><div class="line">num.partitions=1</div><div class="line">num.recovery.threads.per.data.dir=1</div><div class="line">log.retention.hours=168</div><div class="line">log.segment.bytes=1073741824</div><div class="line">log.retention.check.interval.ms=300000</div><div class="line">delete.topic.enable=true</div><div class="line">auto.create.topics.enable=false</div><div class="line">zookeeper.connect=172.20.0.203:2181,172.30.0.199:2181,172.17.71.113:2181</div><div class="line">zookeeper.connection.timeout.ms=6000</div><div class="line"></div><div class="line"><span class="meta">#</span> kafka-2</div><div class="line"><span class="meta">#</span>注意和集群中其他机器不同</div><div class="line">broker.id=1   </div><div class="line">listeners=PLAINTEXT://172.30.0.199:9092</div><div class="line"><span class="meta">#</span>当前机器的ip</div><div class="line">advertised.host.name=172.30.0.199 </div><div class="line">num.network.threads=3</div><div class="line">num.io.threads=8</div><div class="line">socket.send.buffer.bytes=102400</div><div class="line">socket.receive.buffer.bytes=102400</div><div class="line">socket.request.max.bytes=104857600</div><div class="line">log.dirs=/opt/soft/kafka/logs</div><div class="line">num.partitions=1</div><div class="line">num.recovery.threads.per.data.dir=1</div><div class="line">log.retention.hours=168</div><div class="line">log.segment.bytes=1073741824</div><div class="line">log.retention.check.interval.ms=300000</div><div class="line">delete.topic.enable=true</div><div class="line">auto.create.topics.enable=false</div><div class="line">zookeeper.connect=172.20.0.203:2181,172.30.0.199:2181,172.17.71.113:2181</div><div class="line">zookeeper.connection.timeout.ms=6000</div><div class="line"></div><div class="line"><span class="meta">#</span> kafka-3</div><div class="line"><span class="meta">#</span>注意和集群中其他机器不同</div><div class="line">broker.id=2   </div><div class="line">listeners=PLAINTEXT://172.17.71.113:9092</div><div class="line"><span class="meta">#</span>当前机器的ip</div><div class="line">advertised.host.name=172.17.71.113 </div><div class="line">num.network.threads=3</div><div class="line">num.io.threads=8</div><div class="line">socket.send.buffer.bytes=102400</div><div class="line">socket.receive.buffer.bytes=102400</div><div class="line">socket.request.max.bytes=104857600</div><div class="line">log.dirs=/opt/soft/kafka/logs</div><div class="line">num.partitions=1</div><div class="line">num.recovery.threads.per.data.dir=1</div><div class="line">log.retention.hours=168</div><div class="line">log.segment.bytes=1073741824</div><div class="line">log.retention.check.interval.ms=300000</div><div class="line">delete.topic.enable=true</div><div class="line">auto.create.topics.enable=false</div><div class="line">zookeeper.connect=172.20.0.203:2181,172.30.0.199:2181,172.17.71.113:2181</div><div class="line">zookeeper.connection.timeout.ms=6000</div></pre></td></tr></table></figure>
<p>上边配置完成后分别在各个机器上启动。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> bin/kafka-server-start.sh config/server.properties &amp;</div></pre></td></tr></table></figure>
<p>然后看看进程有没有启动成功</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[felk@blv0104 kafka]$ jps</div><div class="line">4740 Kafka</div><div class="line">6806 QuorumPeerMain</div><div class="line">16936 Main</div><div class="line">2750 ConsoleConsumer</div></pre></td></tr></table></figure>
<p>为了验证集群是否配置成功，我们可以开启一个生产者，然后在其他机器开启消费者，若是都能正常消费生产者发出的消息，那么可以证明此时集群是运行正常的。</p>
<h3 id="配置logstash集群"><a href="#配置logstash集群" class="headerlink" title="配置logstash集群"></a>配置logstash集群</h3><p>logstash配置是整个集群最麻烦的一个模块，涉及到改动比较多，我们解析nginx日志此时不在用正则去解析匹配了，而是先将nginx format的格式，用‘|’来间隔，这样就能直接使用ruby的spite方法将各个字段解析出来。</p>
<p>基于之前的单点配置，这里集群的配置并不需要改动多少配置，只需要将<code>logstash.conf</code>文件的input、output模块修改，主要是在各台机器上修改下面的内容<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div></pre></td><td class="code"><pre><div class="line">input&#123;</div><div class="line">    kafka&#123;</div><div class="line">       topics =&gt; ["nginx_log"] </div><div class="line">       add_field =&gt; &#123;"myid"=&gt;"nginx_log_input"&#125;</div><div class="line">       bootstrap_servers =&gt; "172.20.0.203:9092,172.30.0.199:9092,172.17.71.113:9092"</div><div class="line">       codec =&gt; "json"</div><div class="line">    &#125;</div><div class="line">    kafka&#123;</div><div class="line">       topics =&gt; ["bling-service-tps"] </div><div class="line">       add_field =&gt; &#123;"myid"=&gt;"bling-service-tps"&#125;</div><div class="line">       bootstrap_servers =&gt; "172.20.0.203:9092,172.30.0.199:9092,172.17.71.113:9092"</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">filter &#123;</div><div class="line">   if [myid] == "nginx_log_input" &#123; </div><div class="line">    ruby &#123;</div><div class="line">            init =&gt; "@kname = ['remote_addr','time_local','host','request','status','body_bytes_sent','http_referer','http_x_forwarded_for','http_user_agent','request_time','upstream_response_time']"</div><div class="line">            code =&gt; "</div><div class="line">                new_event = LogStash::Event.new(Hash[@kname.zip(event.get('message').split('|'))])</div><div class="line">                new_event.remove('@timestamp')</div><div class="line">                event.append(new_event)</div><div class="line">            "</div><div class="line">    &#125;</div><div class="line">    if [request] &#123;</div><div class="line">        ruby &#123;</div><div class="line">            init =&gt; "@kname = ['method','uri']"</div><div class="line">            code =&gt; "</div><div class="line">                new_event = LogStash::Event.new(Hash[@kname.zip(event.get('request').split(' '))]) </div><div class="line">                new_event.remove('@timestamp')</div><div class="line">                event.append(new_event)</div><div class="line">            "</div><div class="line">    &#125;</div><div class="line">    if [uri] &#123;</div><div class="line">        ruby &#123;</div><div class="line">            init =&gt; "@kname = ['url_path','url_args']"</div><div class="line">            code =&gt; "</div><div class="line">                new_event = LogStash::Event.new(Hash[@kname.zip(event.get('uri').split('?'))])</div><div class="line">                new_event.remove('@timestamp')</div><div class="line">                new_event.remove('url_args')</div><div class="line">                event.append(new_event)</div><div class="line">            "</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">   if [url_path] &#123;</div><div class="line">            ruby &#123;</div><div class="line">                init =&gt; "@kname = ['service_name', 'module_name']"</div><div class="line">                code =&gt; "</div><div class="line">                    new_event = LogStash::Event.new(Hash[@kname.zip(event.get('uri').split('/'))])</div><div class="line">                    new_event.remove('service_name')</div><div class="line">                    new_event.remove('@timestamp')</div><div class="line">                    event.append(new_event)</div><div class="line">                "</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    mutate&#123;</div><div class="line">           convert =&gt; ["request_time", "float"]</div><div class="line">           convert =&gt; ["status", "integer"]</div><div class="line">           convert =&gt; ["body_bytes_sent", "float"]</div><div class="line">           convert =&gt; ["upstream_response_time", "float"]</div><div class="line">    &#125;</div><div class="line">    if [module_name] == "monitor" or [module_name] == "weixin" or [method] == "OPTIONS" &#123;</div><div class="line">            drop &#123;&#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line">output &#123;</div><div class="line">    if [myid] == "nginx_log_input" &#123;</div><div class="line">        elasticsearch&#123;</div><div class="line">        hosts =&gt; ["172.20.0.203:9200", "172.30.0.199:9200", "172.17.71.113:9200"]</div><div class="line">        index =&gt; "nginx-log"</div><div class="line">        template_overwrite =&gt; true</div><div class="line">        template =&gt; "/opt/soft/logstash/output/es_template.json"</div><div class="line">        &#125;</div><div class="line">        stdout&#123;codec =&gt; rubydebug&#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if [myid] == "bling-service-tps" &#123;</div><div class="line">        elasticsearch&#123;</div><div class="line">            hosts =&gt; ["172.20.0.203:9200", "172.30.0.199:9200", "172.17.71.113:9200"]</div><div class="line">            index =&gt; "bling-service-tps"</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>中间的filter模块不动改动。</p>
<h3 id="配置es集群"><a href="#配置es集群" class="headerlink" title="配置es集群"></a>配置es集群</h3><p>1、还是分别在es的根目录下边分别创建logs、data目录<br>2、然后进入<code>config</code>目录中编辑elasticsearch.yml</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span> es-1</div><div class="line">cluster.name: BlingABC_ES-Cluster </div><div class="line">path.data: /opt/soft/elasticsearch-5.6.14/data</div><div class="line">path.logs: /opt/soft/elasticsearch-5.6.14/logs</div><div class="line">node.name: BlingABC_ES1 </div><div class="line">node.data: true</div><div class="line">node.master: true</div><div class="line">network.host: 172.20.0.203</div><div class="line">http.port: 9200</div><div class="line">discovery.zen.ping.unicast.hosts: ["172.20.0.203", "172.30.0.199", "172.17.71.113"]</div><div class="line">discovery.zen.minimum_master_nodes: 2</div><div class="line">http.cors.enabled: true</div><div class="line">http.cors.allow-origin: "*"</div><div class="line">http.cors.allow-headers: Authorization,X-Requested-With,Content-Length,Content-Type</div><div class="line">bootstrap.memory_lock: false</div><div class="line">bootstrap.system_call_filter: false</div><div class="line"></div><div class="line"><span class="meta">#</span>es-2</div><div class="line">cluster.name: BlingABC_ES-Cluster </div><div class="line">path.data: /opt/soft/elasticsearch-5.6.14/data</div><div class="line">path.logs: /opt/soft/elasticsearch-5.6.14/logs</div><div class="line">node.name: BlingABC_ES2 </div><div class="line">node.data: true</div><div class="line">node.master: true</div><div class="line">network.host: 172.30.0.199 </div><div class="line">http.port: 9200</div><div class="line">discovery.zen.ping.unicast.hosts: ["172.20.0.203", "172.30.0.199", "172.17.71.113"]</div><div class="line">discovery.zen.minimum_master_nodes: 2</div><div class="line">http.cors.enabled: true</div><div class="line">http.cors.allow-origin: "*"</div><div class="line">http.cors.allow-headers: Authorization,X-Requested-With,Content-Length,Content-Type</div><div class="line">bootstrap.memory_lock: false</div><div class="line">bootstrap.system_call_filter: false</div><div class="line"></div><div class="line"><span class="meta">#</span>es-3</div><div class="line">cluster.name: BlingABC_ES-Cluster </div><div class="line">path.data: /opt/soft/elasticsearch-5.6.14/data</div><div class="line">path.logs: /opt/soft/elasticsearch-5.6.14/logs</div><div class="line">node.name: BlingABC_ES3 </div><div class="line">node.data: true</div><div class="line">node.master: true</div><div class="line">network.host: 172.17.71.113 </div><div class="line">http.port: 9200</div><div class="line">discovery.zen.ping.unicast.hosts: ["172.20.0.203", "172.30.0.199", "172.17.71.113"]</div><div class="line">discovery.zen.minimum_master_nodes: 2</div><div class="line">http.cors.enabled: true</div><div class="line">http.cors.allow-origin: "*"</div><div class="line">http.cors.allow-headers: Authorization,X-Requested-With,Content-Length,Content-Type</div><div class="line">bootstrap.memory_lock: false</div><div class="line">bootstrap.system_call_filter: false</div></pre></td></tr></table></figure>
<p>上边需要注意的几个配置:</p>
<p><code>cluster.name</code>：三台机器中这个字段值都是一致的，表示这个集群的名称。<br><code>node.name</code>:各个节点的名称，三台机器中这个值都是不同的。<br><code>discovery.zen.ping.unicast.hosts</code>:es集群相互通信的主机ip，若是不填端口，默认是<code>9092</code>端口。<br><code>discovery.zen.minimum_master_nodes</code>：这个值推荐是节点数 n/2+1 </p>
<p>3、分别启动<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ ./bin/elasticsearch &amp;</div></pre></td></tr></table></figure></p>
<p>4、我们在第三步已经将es集群启动了，但是我们应该检查一下当前es集群状态是否成功。我们需要借助一个插件<code>elasticsearch-head</code>，</p>
<p>这里我们就不记录这个插件的安装启动了。启动之后我们访问9100端口，若能看到下面的内容，说明此时集群状态正常。</p>
<p><img src="media/15548098580919.jpg" alt=""></p>
<h4 id="定期删除es中的数据"><a href="#定期删除es中的数据" class="headerlink" title="定期删除es中的数据"></a>定期删除es中的数据</h4><p>我们的es集群中若是不设置定期删除索引，es本身是不会主动删除之前索引的，为了减少存储量、加快查询速度，我们可以使用es自带的删除工具<code>_delete_by_query</code>可以很简单的实现定期删除指定时间之前的数据。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">curl -H 'Content-Type:application/json' -d'&#123;</div><div class="line">    "query": &#123;</div><div class="line">        "range": &#123;</div><div class="line">            "@timestamp": &#123;</div><div class="line">                "lt": "now-7d",</div><div class="line">                "format": "epoch_millis"</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;' -XPOST "http://172.17.71.113:9200/*-*/_delete_by_query?pretty"</div></pre></td></tr></table></figure>
<p>以上的语句就可以将当前集群中7天以前的数据删除。然后我们可以考虑创建一个定时任务来执行清理任务。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">* 0 * * * /usr/bin/curl -u username:password  -H&apos;Content-Type:application/json&apos; -d&apos;&#123;&quot;query&quot;:&#123;&quot;range&quot;:&#123;&quot;@timestamp&quot;:&#123;&quot;lt&quot;:&quot;now-7d&quot;,&quot;format&quot;:&quot;epoch_millis&quot;&#125;&#125;&#125;&#125;&apos; -XPOST &quot;http://127.0.0.1:9200/*-*/_delete_by_query?pretty&quot; &gt; /tmp/elk_clean.txt</div></pre></td></tr></table></figure>
<p>每天0点删除超过7天的无效索引</p>
<h3 id="配置kibana集群"><a href="#配置kibana集群" class="headerlink" title="配置kibana集群"></a>配置kibana集群</h3><p>在这个集群中，kibana负责为用户提供页面展示，我们在三台机器中分别部署kibana服务，然后前面加上nginx的反向代理来将用户请求分散到三台机器中。</p>
<p>kibana的配置非常简单</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">kibana-1</div><div class="line">server.port: 5601</div><div class="line">server.host: "172.20.0.203"</div><div class="line">server.name: "BlingABC_Kibana"</div><div class="line">elasticsearch.url: "http://172.20.0.203:9200"</div><div class="line"></div><div class="line">kibana-2</div><div class="line">server.port: 5601</div><div class="line">server.host: "172.30.0.199"</div><div class="line">server.name: "BlingABC_Kibana"</div><div class="line">elasticsearch.url: "http://172.30.0.199:9200"</div><div class="line"></div><div class="line">kibana-3</div><div class="line">server.port: 5601</div><div class="line">server.host: "172.17.71.113"</div><div class="line">server.name: "BlingABC_Kibana"</div><div class="line">elasticsearch.url: "http://172.17.71.113:9200"</div></pre></td></tr></table></figure>
<p>分别启动<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./bin/kibana &amp;</div></pre></td></tr></table></figure></p>
<p>接下来可以直接通过ip访问具体服务了</p>
<p>比如我们访问<code>http://172.17.71.113:5601</code>可以看到如下页面（这里是已经创建好索引的）</p>
<p><img src="media/15548099030473.jpg" alt=""></p>
<h3 id="安装Grafana"><a href="#安装Grafana" class="headerlink" title="安装Grafana"></a>安装Grafana</h3><p>先去官网下载对应操作系统的Grafana安装源</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> sudo yum localinstall grafana-6.0.2-1.x86_64.rpm</div></pre></td></tr></table></figure>
<p>启动<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ nohup sudo service grafana-server start &amp;</div></pre></td></tr></table></figure></p>
<p>查看状态<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sudo service grafana-server status</div></pre></td></tr></table></figure></p>
<p>我们可以在/etc/grafana/grafana.ini中自定义一些grafana的一些参数。</p>
<hr>
<h3 id="备注：集群启动指令"><a href="#备注：集群启动指令" class="headerlink" title="备注：集群启动指令"></a>备注：集群启动指令</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">// 启动zookeeper</div><div class="line"><span class="meta">$</span> nohup bin/zookeeper-server-start.sh -daemon config/zookeeper.properties &amp;</div><div class="line">// 启动kafka</div><div class="line"><span class="meta">$</span> nohup bin/kafka-server-start.sh config/server.properties &amp;</div><div class="line">// 启动logstash</div><div class="line"><span class="meta">$</span> nohup ./bin/logstash -f config/logstash.conf &amp; </div><div class="line">// 启动es</div><div class="line"><span class="meta">$</span> nohup ./bin/elasticsearch &amp;</div><div class="line">// 启动es插件</div><div class="line"><span class="meta">$</span> nohup npm run start &amp;</div><div class="line">// 启动kibana</div><div class="line"><span class="meta">$</span> nohup ./bin/kibana &amp;</div><div class="line">// 启动grafana</div><div class="line"><span class="meta">$</span> nohup sudo service grafana-server start &amp;</div><div class="line">// 查看grafana状态</div><div class="line"><span class="meta">$</span> sudo service grafana-server status</div></pre></td></tr></table></figure>
<hr>
<h4 id="kafka的一些操作"><a href="#kafka的一些操作" class="headerlink" title="kafka的一些操作"></a>kafka的一些操作</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">// 查看当前kafka集群的topic</div><div class="line"><span class="meta">$</span> bin/kafka-topics.sh --list --zookeeper 172.20.0.203:2181,172.30.0.199:2181,172.17.71.113:2181</div><div class="line">// 查看nginx_log主题的信息</div><div class="line"><span class="meta">$</span> bin/kafka-console-consumer.sh --zookeeper 172.20.0.203:2181,172.30.0.199:2181,172.17.71.113:2181 --topic nginx_log</div><div class="line"><span class="meta">$</span> 创建主题</div><div class="line"><span class="meta">$</span> bin/kafka-topics.sh --create --zookeeper 172.20.0.203:2181,172.30.0.199:2181,172.17.71.113:2181 --replication-factor 1 --partitions 1 --topic bling-service-general</div></pre></td></tr></table></figure>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-delete-by-query.html" target="_blank" rel="external">Elasticsearch Reference </a><br><a href="https://juejin.im/post/58e5de06ac502e006c254145" target="_blank" rel="external">elasticsearch按照日期定时批量删除索引</a><br><a href="https://blog.csdn.net/piantoutongyang/article/details/88811840" target="_blank" rel="external">偏头痛杨的分布式日志框架ELK入门helloworld</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/18/历史的逻辑/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="leonyoung">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://res.cloudinary.com/leon824/image/upload/v1505793001/IMG_3957_uwrsum.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="花谢花开">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/02/18/历史的逻辑/" itemprop="url">历史的逻辑</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              
              <time title="創建於" itemprop="dateCreated datePublished" datetime="2019-02-18T16:32:34+08:00">
                2019-02-18
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/读书笔记/" itemprop="url" rel="index">
                    <span itemprop="name">读书笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字數統計&#58;</span>
                
                <span title="字數統計">
                  2,117
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">閱讀時長 &asymp;</span>
                
                <span title="閱讀時長">
                  7
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="历史的逻辑"><a href="#历史的逻辑" class="headerlink" title=" 历史的逻辑"></a><center> 历史的逻辑</center></h2><h4 id="–-读《晚清到民国》有感"><a href="#–-读《晚清到民国》有感" class="headerlink" title="– 读《晚清到民国》有感"></a><p align="right">– 读《晚清到民国》有感</p></h4><p>&emsp;&emsp;给自己定下了一个目标——每读完一本书就要写一点读书感想，希望从今天开始坚持下来。<br>    余讀此書，給我最大的感受便是，孫文所講的：“天下大勢，順之則昌，逆之則亡”。從1840年起，距今快180年，這個過程仍然沒有結束。下邊就嘗試自己來總結一下整個過程。<br>&emsp;&emsp;沉睡中的帝國第一次被敲醒，西方文明從文藝復興啟動“中古文化”的現代化過程，經歷大航海時代、工業革命。已經在政治體制、工業生產力、科學文化創新等方方面面超過東方的古老文明。從一個小例子便能看出來。乾隆年間，英國公使代表英王送來當時西方最先進的步槍、以及其他代表当时最先进科技的“贡品”。而乾隆皇帝則表示：我大天朝富有四海，豈需要而小國貨物哉？特別是當庚子國變之後，八國聯軍進入北京，發現當初马戛尔尼使团当初送给乾隆皇帝的步枪放在仓库中甚至都没有打开过，高傲無知可見一斑。<br>&emsp;&emsp;至于第一次鸦片战争，站在今天人的角度看，其结果不言自明，以一个落后的非现代化国家和一个强大的英帝国作战，失败是毫无疑问的。但是当时的人并没有机会开启“上帝之眼”。在当时道光皇帝看來，我天朝擁有四萬萬國民，焉能輸給遠在萬裡之遙的撮兒小國？兒只有林文忠公——中國近代開眼看世界的第一人，在戰爭開始之後，林則徐則知道這是一場不對稱的戰爭，失敗是沒有疑問的，然而皇帝堅持要打，也是毫無辦法的事情。至於兒戰後所簽署的中國近代第一個“不平等”條約——《南京條約》，從今人的角度看來并非為不平等條約，比如開放五口通商，有一點經濟學知識的人都能夠知道，當市場覆蓋越大，邊越能夠促進生產力的發展，對資源的充分利用同樣大有裨益。然而站在當時的統治者角度，我并不願意和你們通商，你強迫我，那就是不平等。 最終，不管你願意不願意，們是被一幫外來者砸出了一個大口子，再也不能獨善其身了。<br>&emsp;&emsp;在第二次鴉片戰爭之前，還發生了讓中國人口減少上億人口的太平天國運動，在王朝統治的末年，統治機器已經腐朽不堪，對底層老百姓無法實現有效統治，甚至有災不賑，那麼底層老百姓也就只能造反了。作者在書中詳細介紹了洪秀全本人的生平，和歷史上很多農民起義類似，底層農民起義無非就是為了金子、女人而已，一旦獲得了不受限制的權利，那麼老百姓就要遭殃了 ！！！<br>&emsp;&emsp;隨之而來的就是第二次鴉片戰爭，這次英法聯軍攻破首都——北京，這也是近代第一次天朝第一次首都被攻陷，咸豐皇帝跑到承德避暑山莊，英法聯軍火燒圓明園，此乃是帝國中醫侵略中國的最重要罪證之一，今日每個中國人提到此事仍然要咬牙切齒的罵上兩句。但是要知道，在這次戰爭之前，慈禧太后將38名外國使臣殺頭、囚禁在圓明園內，致使最後僅僅十幾位還活著，加上第一次鴉片戰爭所簽署的《南京條約》中方一致推諉，不允許外國人“入境”。多個原因之下，發生了第二次鴉片戰爭。歸根到底，還是這個龐大的帝國沒有切換思路，然後是保留著受害者心態、中學為體西學為用的保守思想，要知道早在大航海時代就已經進行的全球融合豈是你大清國能夠阻擋的？也許在當時的統治者來說，我們並沒有錯啊。是的，這就是天下大勢，不會以個人、國家而改變。<br>&emsp;&emsp;要說清代末年最重要的戰爭，除了第一次鴉片戰爭，可能就是甲午中日戰爭了。這次和我們東邊的老鄰居、“撮兒小國”—— 日本的戰爭。幾乎是導致大清帝國解體最重要的一擊了。本來已經在第二次鴉片戰爭之後的三十年有中興之象，然而一戰戳破所有幻想。世界第八的海軍輸給世界十四的日本，所有的民族自尊心被擊碎、直至今日仍是如此。書中讀到這段歷史的時候感慨頗多，一個國家的“國運”往上走的時候，真實一順百順；若是“國運”往下走的時候，便不是人力所能改變的了。想想當初日本人立志想要打造海軍，上萬日本婦女們為了國家下南洋賣淫來籌集軍費，而我們的老佛爺還要挪用上千萬的軍費來建造自己退休的園子——頤和園。也許看到這裡，也就不需要在去關注戰爭本身的細節了，勝負其實早在戰爭之前就已經註定了，無需多言。<br>&emsp;&emsp;時針撥到1900年，也就是庚子年。這一次八國聯軍侵華又是由於義和團對洋人的攻擊而直接導致。吊詭的是，義和團產生的一個重要原因便是洋人在中國的作威作福，和底層老百姓發生沖突的時候地方官府根本對洋人無可奈何，吃虧的只能是中國的老百姓。君不知，當時一個主教和一方大員的巡撫、總督處於同一級別！ 於是一幫叫義和拳的群體漸漸成長起來，他們的口號是“扶清滅洋”。當時的慈禧老太太當然也知道這幫人不過是虛張聲勢的一幫烏合之眾，但是“其心可用”。 但是真正讓慈禧下決心向十一國宣戰的真正原因乃是“蔣幹偷書”，其中最重要的一條是讓慈禧還政于光緒皇帝。君不見，獨裁者最怕的永遠都是失去權利，而國家的興亡、普通老百姓的死活不在她的考慮範圍內，如此史上“最勇敢”的老太太便誕生了，以已過之力，向所有邦交國宣戰，要知道拿破崙、希特勒、斯大林都沒這樣“勇敢”過。結果也是不出意料，幾萬雜牌聯軍在很短的時間內邊攻破北京，帝國的首都便再一次被蹂躪，遭殃的當然還是帝都的老百姓。<br>&emsp;&emsp;至於後邊的辛亥革命則是壓死駱駝的最後一根稻草，意味著2000多年的帝國統治的結束。然後從1912年到今天，整整100多年過去了，我們的“中古文化現代化”就完成了嗎？在唐先生的觀點開來，大概要等到2040年，具體第一次鴉片戰爭200年方能完成。這個觀點在我有限的認知裡邊是讚成的，今日之中國看似包著一個現代化國家的外衣，骨子里還是帝王的那一套。正好此時此刻正在南美洲-阿根廷召開的G20峰會正在舉行，最重要的中美元首會面也將在十幾個小時之後進行，這次會面也許是一個轉折點，決定中美是否能否緩和關係，還是繼續升級對抗，邊拭目以待吧。<br>&emsp;&emsp;歷史很多時候就是“不識廬山真面目，只緣身在此山中”，今日所發生的很多事情，我們沒有辦法去證實、弄明白背後真正的緣由，好在歷史有其自身的邏輯，今日之事會在未來有一個清楚的交代。<br>                   </p><p align="right">2018/12/1</p>  <p></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/07/单例模式的线程安全问题/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="leonyoung">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://res.cloudinary.com/leon824/image/upload/v1505793001/IMG_3957_uwrsum.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="花谢花开">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/07/单例模式的线程安全问题/" itemprop="url">单例模式的线程安全问题</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              
              <time title="創建於" itemprop="dateCreated datePublished" datetime="2018-09-07T15:28:47+08:00">
                2018-09-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字數統計&#58;</span>
                
                <span title="字數統計">
                  1,100
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">閱讀時長 &asymp;</span>
                
                <span title="閱讀時長">
                  4
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>  <img src="https://res.cloudinary.com/leon824/image/upload/v1536228571/arches-national-park-dark-dusk-33688_onguan.jpg" width="100%" height="100%"></p>
<h2 id="单例模式"><a href="#单例模式" class="headerlink" title="单例模式"></a>单例模式</h2><p>单例模式是最简单的设计模式，分为两种：懒汉模式、恶汉模式</p>
<h3 id="恶汉模式"><a href="#恶汉模式" class="headerlink" title="恶汉模式"></a>恶汉模式</h3><p>在属性中直接创建对象，然后在方法中返回。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Singletom</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Singletom ourInstance = <span class="keyword">new</span> Singletom();</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Singletom <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> ourInstance;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Singletom</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面不存在线程安全的问题，因为加载类的时候就会创建<code>Singletom</code>的对象，然后所有线程来获取的时候都是返回这个对象。</p>
<h3 id="懒汉模式"><a href="#懒汉模式" class="headerlink" title="懒汉模式"></a>懒汉模式</h3><p>刚开始并不直接创建对象，而是在需要的时候在创建，主要代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OtherSingleton</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> OtherSingleton instance;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">OtherSingleton</span><span class="params">()</span> </span>&#123;&#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> OtherSingleton <span class="title">getInstance</span><span class="params">()</span></span>&#123;</div><div class="line">             <span class="keyword">if</span> (instance == <span class="keyword">null</span>)&#123;      ————<span class="number">1</span></div><div class="line">                 instance = <span class="keyword">new</span> OtherSingleton(); —————<span class="number">2</span></div><div class="line">                 <span class="keyword">return</span> instance;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> instance;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个时候是线程不安全的，假设两个线程一前一后来执行<code>getInstance()</code>方法，这个时候线程<strong>A</strong>正在执行2这个位置，由于<code>new</code>对象并非一个<strong>原子操作</strong>，分为以下<strong>三步</strong>：</p>
<ul>
<li>1) 在内存中分配空间。</li>
<li>2) 调用构造函数初始化对象。</li>
<li>3）将<code>instance</code>引用指向堆内存空间的起始地址（此时<code>instance</code>才为非<code>null</code>）。</li>
</ul>
<p>若将上边三步用伪代码来表示就是下边这样：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">memory = allocate();  <span class="comment">//  1、分配对象的内存空间</span></div><div class="line">ctorInstance(memory); <span class="comment">// 2、初始化对象</span></div><div class="line">instance = memory；  <span class="comment">//3、设置instance指向刚分配的内存地址</span></div></pre></td></tr></table></figure>
<p>实际上在上边的伪代码中2和3之间，可能会被重排序（在一些JIT编译器上，这种重排序也是真实发生的） ，根据《java语言规范》，所有线程在执行java程序时必须遵守<strong>intra-thread semantics</strong>,<strong>intra-thread semantics</strong>保证排序不会改变单线程的执行结果。换句话说，<strong>intra-thread semantics</strong>允许那些在单线程中不改变执行结果的重排序，这样会提高程序的执行性能。</p>
<p>这个时候<strong>A</strong>线程执行刚刚才执行到创建对象的<strong>第二步</strong>，线程<strong>B</strong>就执行到代码<strong>1</strong>处，此时判断出<code>instance</code>为<code>null</code>，然后进入对象在创建一个对象！ 这个时候就出现问题了，单例模式此时创建了两个对象。违背了单例模式的初衷。</p>
<h3 id="双重锁检查"><a href="#双重锁检查" class="headerlink" title="双重锁检查"></a>双重锁检查</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OtherSingleton</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> OtherSingleton instance;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">OtherSingleton</span><span class="params">()</span> </span>&#123;&#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> OtherSingleton <span class="title">getInstance</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">if</span> (instance == <span class="keyword">null</span>)&#123;  ————<span class="number">1</span></div><div class="line">            <span class="keyword">synchronized</span> (OtherSingleton.class)&#123;</div><div class="line">             <span class="keyword">if</span> (instance == <span class="keyword">null</span>)&#123;    ————<span class="number">2</span></div><div class="line">                 instance = <span class="keyword">new</span> OtherSingleton();   ————<span class="number">3</span></div><div class="line">                 <span class="keyword">return</span> instance;</div><div class="line">             &#125;</div><div class="line">           &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> instance;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里加双重检查锁就是在同步代码前和同步代码后边都检查实例是否为空。如果仅仅在同步块外边检查，而在同步块内不检查，那么可能存在多个线程同时进入了同步块外的代码，则可能<strong>生成多个实例</strong>。</p>
<p>上边代码看起来还不错，但是他还是有问题的。问题出现在代码<strong>3</strong>处，这个地方并非是原子操作，如上边的描述分为<strong>三步</strong>。由于<code>cpu</code>为了提高执行效率可能会将这个三步分为<strong>1-2-3</strong>或者<strong>1-3-2</strong>。</p>
<p>如果线程<strong>A</strong>执行到代码<strong>3</strong>处的<strong>1-3</strong>步，此时<code>instance</code>已经不为<code>null</code>了，但是创建对象的第二部却并没有执行。而此时线程<strong>B</strong>进入到方法的<strong>1</strong>处，判断<code>instance</code>是否为空，此时已经不会空了，但是返回的对象却并没有初始化，顺理成章的报错。。</p>
<p>这里的关键是<code>instance</code>对象还没有初始化执行<strong>第二步</strong>，就执行的<strong>第三步</strong>，导致线程<strong>B</strong>拿到一个空的对象。那么我们只需要让<code>cpu</code>在执行创建对象时禁止重排序就能够解决这个问题了。<br>明显需要使用<code>volatile</code>关键字来禁止重排序。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OtherSingleton</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">static</span> OtherSingleton instance;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">OtherSingleton</span><span class="params">()</span> </span>&#123;&#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> OtherSingleton <span class="title">getInstance</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">if</span> (instance == <span class="keyword">null</span>)&#123;</div><div class="line">            <span class="keyword">synchronized</span> (OtherSingleton.class)&#123;</div><div class="line">             <span class="keyword">if</span> (instance == <span class="keyword">null</span>)&#123;</div><div class="line">                 instance = <span class="keyword">new</span> OtherSingleton();</div><div class="line">                 <span class="keyword">return</span> instance;</div><div class="line">             &#125;</div><div class="line">           &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> instance;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里利用的是<code>volatile</code>的禁止重排序的性质，在<code>volatile</code>变量的赋值操作后边会加上一个内存屏障，<strong>读操作</strong>不会出现在内存屏障前边，所以<strong>取操作*必须是</strong>1-2-3<strong>或者</strong>1-3-2<strong>之后，不存在</strong>1-3**之后就读取到。从<code>happen-before</code>原则来看，就是对于一个 <code>volatile</code> 变量的写操作都先行发生于后面对这个变量的读操作（这里的“后面”是时间上的先后顺序）。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="http://wuchong.me/blog/2014/08/28/how-to-correctly-write-singleton-pattern/" target="_blank" rel="external">如何正确地写出单例模式</a></li>
<li>《java并发编程的艺术》</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/06/分布式调度中心/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="leonyoung">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://res.cloudinary.com/leon824/image/upload/v1505793001/IMG_3957_uwrsum.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="花谢花开">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/06/分布式调度中心/" itemprop="url">分布式调度中心</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              
              <time title="創建於" itemprop="dateCreated datePublished" datetime="2018-09-06T17:22:37+08:00">
                2018-09-06
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字數統計&#58;</span>
                
                <span title="字數統計">
                  1,916
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">閱讀時長 &asymp;</span>
                
                <span title="閱讀時長">
                  7
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="https://res.cloudinary.com/leon824/image/upload/v1536228539/america-american-american-flag-92730_nxhmbn.jpg" width="90%" height="90%"></p>
<blockquote>
<p>最近公司的服务已经从传统tomcat服务拆分成了微服务，使得各个原本臃肿的业务变得轻量、易维护，但是也带了一些问题，比如生产、测试环境中的定时任务管理就成了问题，由于服务器变得更多，定时任务变得分散，各个环境容易变得混杂、维护成本升高且容易出错，同时无法知道这个定时任务执行是否成功，只有当服务出现了问题才能反推定时任务出现了问题。</p>
</blockquote>
<h2 id="使用系统级定时crontab存在的主要问题"><a href="#使用系统级定时crontab存在的主要问题" class="headerlink" title="使用系统级定时crontab存在的主要问题"></a>使用系统级定时crontab存在的主要问题</h2><ul>
<li>任务的时间粒度不够小（只能是分钟级别以上）</li>
<li>当任务没有执行的时候没有通知，不能及时发现定时任务是否执行，只有当出现异常的时候才能发现定时的执行出现了问题。</li>
<li>任务执行过程没有日志记录，出现的问题不容易定位</li>
<li>没有失败处理策略（失败重试、失败告警）</li>
<li>没有阻塞策略</li>
<li><p>依赖运维人员，低效</p>
<p>那么上边这些问题要怎样解决呢？ 我们可以使用分布式调度系统来彻底解决这些痛点。</p>
</li>
</ul>
<h2 id="分布式调度系统"><a href="#分布式调度系统" class="headerlink" title="分布式调度系统"></a>分布式调度系统</h2><ul>
<li><code>TBSchedule</code>：阿里早期开源的分布式任务调度系统。代码略陈旧，使用timer而非线程池执行任务调度。众所周知，timer在处理异常状况时是有缺陷的。而且TBSchedule作业类型较为单一，只能是获取/处理数据一种模式。还有就是文档缺失比较严重</li>
<li><code>Saturn</code>：是唯品会自主研发的分布式的定时任务的调度平台，基于当当的elastic-job 版本1开发，并且可以很好的部署到docker容器上。</li>
<li><code>elastic-job</code>：当当开发的弹性分布式任务调度系统，功能丰富强大，采用zookeeper实现分布式协调，实现任务高可用以及分片，目前是版本2.15，并且可以支持云开发</li>
<li><code>xxl-job</code>: 是大众点评员工徐雪里于2015年发布的分布式任务调度平台，是一个轻量级分布式任务调度框架，其核心设计目标是开发迅速、学习简单、轻量级、易扩展</li>
</ul>
<p>在上边这几种解决方案中，以<strong>xxl-job</strong>和<strong>elastic-job</strong>用的更多、文档相对完善。</p>
<ul>
<li>共同点： <code>E-Job</code>和<code>X-job</code>都有广泛的用户基础和完整的技术文档，都能满足定时任务的基本功能需求。</li>
<li>不同点：<code>X-Job</code> 侧重的业务实现的简单和管理的方便，学习成本简单，失败策略和路由策略丰富。推荐使用在“用户基数相对少，服务器数量在一定范围内”的情景下使用<br><code>E-Job</code> 关注的是数据，增加了弹性扩容和数据分片的思路，以便于更大限度的利用分布式服务器的资源。但是学习成本相对高些，推荐在“数据量庞大，且部署服务器数量较多”时使用</li>
</ul>
<p>根据我们业务的数据量、用户数量可以采用<code>xxl-job</code>快速实现分布式任务调度中心。</p>
<h2 id="xxl-job下载、运行"><a href="#xxl-job下载、运行" class="headerlink" title="xxl-job下载、运行"></a>xxl-job下载、运行</h2><p>首先我们先去<code>github</code>中下载<code>xxl-job</code>最新的代码</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;</span> git clone https://github.com/xuxueli/xxl-job.git</div></pre></td></tr></table></figure>
<p>  然后在<code>idea</code>中加载这个模块</p>
<p>  <img src="https://res.cloudinary.com/leon824/image/upload/v1536229716/xxl-job2_dmcr7w.png" width="60%" height="60%"></p>
<p>  注意上边的三个黄色框圈起来的部分，从上往下：</p>
<p>  1、<code>tables_xxl_job.sql</code>这个是我们在库里边创建的库-表，执行之后会有16张表被创建</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;</span> mysql -uroot -p &lt; tables_xxl_job.sql</div></pre></td></tr></table></figure>
<p>  <img src="  https://res.cloudinary.com/leon824/image/upload/v1536229989/xxl-job3_znsdti.png" width="40%" height="50%"></p>
<p>  2、<code>xxl-job-admin</code>就是调度中心，我们需要修改<code>resources</code>里边的<code>xxl-job-admin.properties</code>文件一些字段</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">  <span class="comment">### xxl-job db  (use &amp;amp; replace &amp; in xml)</span></div><div class="line"><span class="string">xxl.job.db.driverClass=com.mysql.jdbc.Driver</span></div><div class="line"><span class="string">xxl.job.db.url=jdbc:mysql://localhost:3306/xxl-job?useUnicode=true&amp;characterEncoding=UTF-8</span></div><div class="line"><span class="string">xxl.job.db.user=root</span></div><div class="line"><span class="string">xxl.job.db.password=123456</span></div><div class="line"></div><div class="line"><span class="comment">### xxl-job email</span></div><div class="line"><span class="string">xxl.job.mail.host=smtp.163.com</span></div><div class="line"><span class="string">xxl.job.mail.port=25</span></div><div class="line"><span class="string">xxl.job.mail.username=ovono802302@163.com</span></div><div class="line"><span class="string">xxl.job.mail.password=asdfzxcv</span></div><div class="line"><span class="string">xxl.job.mail.sendNick=《任务调度平台XXL-JOB》</span></div><div class="line"></div><div class="line"><span class="comment">### xxl-job login</span></div><div class="line"><span class="string">xxl.job.login.username=admin</span></div><div class="line"><span class="string">xxl.job.login.password=123456</span></div><div class="line"></div><div class="line"><span class="comment">### xxl-job, access token</span></div><div class="line"><span class="string">xxl.job.accessToken=</span></div><div class="line"><span class="comment">### xxl-job, i18n (default empty as chinese, "en" as english)</span></div><div class="line"><span class="string">xxl.job.i18n=</span></div></pre></td></tr></table></figure>
<p>配置完成之后就可以启动了。</p>
<p> 3、 第三个是<code>xxl-job-executor-sample-springboot</code>这个是xxl-job提供的执行器中的一种，另外还支持<code>spring</code>等等，修改配置文件，将相应参数修改成和自己环境匹配的参数。</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># web port</span></div><div class="line"><span class="string">server.port=8081</span></div><div class="line"></div><div class="line"><span class="comment"># log config</span></div><div class="line"><span class="string">logging.config=classpath:logback.xml</span></div><div class="line"></div><div class="line"><span class="comment">### xxl-job admin address list, such as "http://address" or "http://address01,http://address02"</span></div><div class="line"><span class="string">xxl.job.admin.addresses=http://127.0.0.1:8080/xxl-job-admin</span></div><div class="line"></div><div class="line"><span class="comment">### xxl-job executor address</span></div><div class="line"><span class="string">xxl.job.executor.appname=xxl-job-executor-sample</span></div><div class="line"><span class="string">xxl.job.executor.ip=</span></div><div class="line"><span class="string">xxl.job.executor.port=9999</span></div><div class="line"></div><div class="line"><span class="comment">### xxl-job, access token</span></div><div class="line"><span class="string">xxl.job.accessToken=</span></div><div class="line"></div><div class="line"><span class="comment">### xxl-job log path</span></div><div class="line"><span class="string">xxl.job.executor.logpath=/Users/leon/work/logs/xxl-job/jobhandler</span></div><div class="line"><span class="comment">### xxl-job log retention days</span></div><div class="line"><span class="string">xxl.job.executor.logretentiondays=-1</span></div></pre></td></tr></table></figure>
<p> 上边执行器是具体执行任务的模块。下边就来具体讲讲xxl-job整体使用架构图。</p>
<p>  <img src="https://res.cloudinary.com/leon824/image/upload/v1536054290/Pic2432_m0orgo.png" width="100%" height="90%"></p>
<p>  上图中虚线包围起来的两个部分就是xxl-job最重要的部分，一个叫<strong>调度中心</strong>，一个叫<strong>执行器</strong>（<em>我更愿意叫他<code>执行器群</code></em>）。其中<strong>调度中心</strong>负责所有执行器群的管理，各个执行器群的任务分发管理，日志的查询等等功能，而<strong>执行器</strong>负责具体执行任务。而中间的通讯组件则是自研的RPC组件，生产业务执行器就相当于是生产环境的执行器群，测试业务执行器相当于测试环境的执行器群。这样就能满足将各个环境通过执行器群来区分，然后统一管理起来在一个web后台就能处理所有环境的定时任务了。</p>
<h2 id="调度中心相关"><a href="#调度中心相关" class="headerlink" title="调度中心相关"></a>调度中心相关</h2><p>  要使用xxl-job来管理所有环境的定时任务，首先需要根据环境创建执行器群，然后在知情器群的基础上创建任务。</p>
<h3 id="创建执行器群"><a href="#创建执行器群" class="headerlink" title="创建执行器群"></a>创建执行器群</h3><p>点击web页面左侧的<strong>执行器管理</strong> =&gt; <strong>新增执行器</strong></p>
<p><img src="https://res.cloudinary.com/leon824/image/upload/v1536231480/xxl-job5_virbrp.png" width="70%" height="70%"></p>
<p> 上边的<code>AppName</code>很重要，是区分各个执行器群的标志，如果选择下边的手动录入的话那么就需要将机器<code>ip:port</code>添加到机器地址中。把执行器群创建好了之后就可以创建定时任务了。</p>
<h3 id="创建定时任务"><a href="#创建定时任务" class="headerlink" title="创建定时任务"></a>创建定时任务</h3><p> 点击左侧的<strong>任务管理</strong> =&gt; <strong>新增任务</strong></p>
<p> <img src="https://res.cloudinary.com/leon824/image/upload/v1536231961/xxl-job6_iyd6r8.png" width="70%" height="70%"></p>
<p>  里边的具体选项的含义大家可以去查xxl-job的<a href="http://www.xuxueli.com/xxl-job/#/?id=%E4%B8%89%E3%80%81%E4%BB%BB%E5%8A%A1%E8%AF%A6%E8%A7%A3" target="_blank" rel="external">官方文档</a>，也记录的很详细。这里不在重新复述。</p>
<p>  这里还想多提一点的是他的报警机制，只支持邮件报警，但是相对来说大家打开邮件的频率比较低，平时也许不太关注邮件，所以可能导致一些任务执行失败了我们也没有及时发现。基于上面的原因，就在作者原来的代码基础上增加<strong>钉钉报警</strong>（在<code>github issues</code>中也有人提出过），实现起来也并不复杂。修改之后创建任务的时候多了两个参数，这两个参数也需要在数据库中添加两个字段。</p>
<p>  <img src="https://res.cloudinary.com/leon824/image/upload/v1536232500/xxl-job8_fsxslg.png" width="70%" height="70%"></p>
<p>  若出现任务异常，那么会直接将自定义的信息通过<code>http post</code>的方式发送给配置的钉钉群，下面是我测试的效果。</p>
<p>  <img src="https://res.cloudinary.com/leon824/image/upload/v1536232776/xxl-job9_vnqd4c.png" width="40%" height="40%"></p>
<h2 id="思维导图"><a href="#思维导图" class="headerlink" title="思维导图"></a>思维导图</h2><p>大致画了一下xxl-job的思维导图，还不够完备。</p>
<p><img src="https://res.cloudinary.com/leon824/image/upload/v1536114765/pic110_ugssl2.png" width="100%" height="100%"></p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="https://zhuanlan.zhihu.com/p/36627346" target="_blank" rel="external">美团点评许雪里：分布式任务调度平台 XXL-JOB</a></li>
<li><a href="http://www.xuxueli.com/xxl-job/#/" target="_blank" rel="external">xxl-job官方文档</a></li>
<li><a href="https://www.cnblogs.com/davidwang456/p/9057839.html" target="_blank" rel="external">分布式定时任务调度系统技术选型</a> </li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/08/25/ELK+KAFKA详解(二)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="leonyoung">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://res.cloudinary.com/leon824/image/upload/v1505793001/IMG_3957_uwrsum.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="花谢花开">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/08/25/ELK+KAFKA详解(二)/" itemprop="url">ELK+KAFKA详解(二)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              
              <time title="創建於" itemprop="dateCreated datePublished" datetime="2018-08-25T13:42:14+08:00">
                2018-08-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ELK/" itemprop="url" rel="index">
                    <span itemprop="name">ELK</span>
                  </a>
                </span>

                
                
              
            </span>
          

          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字數統計&#58;</span>
                
                <span title="字數統計">
                  1,356
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">閱讀時長 &asymp;</span>
                
                <span title="閱讀時長">
                  6
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="https://res.cloudinary.com/leon824/image/upload/v1535599872/pic5_pn74x6.jpg" width="80%" height="80%"></p>
<blockquote>
<p> 上一篇文章我们已经将filebeat、kafka、zookeeper、logstash安装配置完毕了。接下来主要是索引数据、展示数据阶段。</p>
</blockquote>
<hr>
<h2 id="安装Elasticsearch"><a href="#安装Elasticsearch" class="headerlink" title="安装Elasticsearch"></a>安装Elasticsearch</h2><p>首先到官网下载5.3.3版本的安装包</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;</span> axel -n 5 https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-5.3.3.tar.gz</div></pre></td></tr></table></figure>
<p>然后在ES的根目录下创建两个目录data、logs，用来保存索引数据、日志等等</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;</span> mkdir logs</div><div class="line"><span class="meta">&gt;</span> mkdir data</div></pre></td></tr></table></figure>
<p>进入<code>config</code>目录编辑<code>elasticsearch.yml</code>文件，这种以.yml类型结尾的文件要注意缩进。</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Path to directory where to store the data (separate multiple locations by comma):</span></div><div class="line"><span class="string">path.data:</span> <span class="string">/opt/soft/elasticsearch-5.5.3/data</span></div><div class="line"><span class="comment"># Path to log files:</span></div><div class="line"><span class="string">path.logs:</span> <span class="string">/opt/soft/elasticsearch-5.5.3/logs</span></div><div class="line"><span class="comment"># 绑定一个指定的ip</span></div><div class="line"><span class="comment"># network.host: 0.0.0.0</span></div><div class="line"><span class="string">http.port:</span> <span class="number">9200</span></div><div class="line"><span class="comment"># 后边使用插件的时候需要使用到下边两个配置。</span></div><div class="line"><span class="string">http.cors.enabled:</span> <span class="literal">true</span></div><div class="line"><span class="string">http.cors.allow-origin:</span> <span class="string">"*"</span></div></pre></td></tr></table></figure>
<p>上边是一些主要的配置，然后可以直接启动ES了</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;</span> ./bin/elasticsearch &amp;</div></pre></td></tr></table></figure>
<p>上边我们是已经启动了，但是我们还不知道数据是否通过<code>logstash</code>写入到ES中，所以我们还需要两个步骤来确保我们安装配置是没有问题的：</p>
<ul>
<li>创建一个索引（ES中的索引类似于数据库中的一个数据库实例） 。</li>
<li>安装<code>head</code>插件，查看ES情况</li>
</ul>
<h3 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h3><p>在这之前我们需要了解ES中的三个基本概念：</p>
<ul>
<li>index：ES管理数据的最顶层单位，类似于单个数据库的概念。</li>
<li>document ：ES的index中单条数据被称为document</li>
<li>type：document可以分组，分组就叫type</li>
</ul>
<p>通过指定一个文件的方式创建一个索引：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;</span>  curl -XPUT 'http://localhost:9200/nginx_log_index/test_log/1?pretty' -H 'Content-Type: application/json' -d '/opt/soft/logstash-5.5.3/output/es_template.json'</div></pre></td></tr></table></figure>
<p>删除索引：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;</span>  curl -X DELETE 'localhost:9200/nginx_log_index'</div></pre></td></tr></table></figure>
<h3 id="安装head插件"><a href="#安装head插件" class="headerlink" title="安装head插件"></a>安装head插件</h3><p>head插件运行需要node环境，这里就不讨论如何安装node了，网上资料比较多。</p>
<p>使用git下载head源码：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;</span> git clone git://github.com/mobz/elasticsearch-head.git</div></pre></td></tr></table></figure>
<p>然后进入head的目录执行指令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;</span> npm install</div></pre></td></tr></table></figure>
<p>启动</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&gt; npm run start</div></pre></td></tr></table></figure>
<p>若是ES使用的都是默认端口，那么<code>head</code>插件就不需要修改配置。</p>
<p>在浏览器中访问<code>http://ip:9100/</code>就可以看到ES的情况</p>
<p><img src="https://res.cloudinary.com/leon824/image/upload/v1535186203/head_yvixk7.png" width="80%" height="80%"></p>
<h3 id="ES补充"><a href="#ES补充" class="headerlink" title="ES补充"></a>ES补充</h3><p>Elasticsearch是一个搜索引擎，我们可以通过它提供的查询语句实现类似sql的查询功能，为我们展示数据提供便利，下面列举一个常用的查询。</p>
<p>1、指定一个index，搜索其下所有type的数据</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;</span> curl -X GET 'http://localhost:9200/nginx-log/_search?pretty' -H 'Content-Type: application/json' -d '  </div><div class="line">&#123;</div><div class="line">  "query": &#123;</div><div class="line">    "match_all": &#123;&#125;</div><div class="line">  &#125;</div><div class="line">&#125;'</div></pre></td></tr></table></figure>
<p>上边的nginx-log就是我们想要查询的index</p>
<p>2、查看每个index所包含的type</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;</span> curl 'localhost:9200/_mapping?pretty=true'</div></pre></td></tr></table></figure>
<p>3、查看当前节点的所有Index</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;</span> curl -X GET 'http://localhost:9200/_cat/indices?v'</div></pre></td></tr></table></figure>
<p>4、根据某个字段进行分组后统计，实现类似于<code>sql</code>里边的功能</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> table_name <span class="keyword">group</span> <span class="keyword">by</span> <span class="keyword">field</span>;</div></pre></td></tr></table></figure>
<p>下面的ES查询语句功能和上边的sql是类似的</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;</span> curl -X POST 'http://localhost:9200/nginx-log/nginxlog/_search?pretty' -H 'Content-Type: application/json' -d'</div><div class="line">&#123;	</div><div class="line">	"size": 0,</div><div class="line">	"aggs": &#123;</div><div class="line">	"group_by_service_name": &#123;</div><div class="line">		"terms": &#123; </div><div class="line">		"field": "service_name.keyword"</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">  &#125;</div><div class="line">&#125;'</div></pre></td></tr></table></figure>
<hr>
<h2 id="安装kibana"><a href="#安装kibana" class="headerlink" title="安装kibana"></a>安装kibana</h2><p>下载：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;</span> axel -n 5 https://artifacts.elastic.co/downloads/kibana/kibana-5.5.3-linux-x86_64.tar.gz</div></pre></td></tr></table></figure>
<p>kibana的安装配置较为简单，只需要在config目录中的kibana.yml文件配置两个字段</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Kibana is served by a back end server. This setting specifies the port to use.</span></div><div class="line"><span class="string">server.port:</span> <span class="number">5601</span></div><div class="line"><span class="comment"># The URL of the Elasticsearch instance to use for all your queries.</span></div><div class="line"><span class="string">elasticsearch.url:</span> <span class="string">"http://localhost:9200"</span></div></pre></td></tr></table></figure>
<p>然后启动</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;</span> ./bin/kibana &amp;</div></pre></td></tr></table></figure>
<p>在第一次启动kibana的时候，需要手动配置一个index，然后kibana会通过这个index去ES中查询并展示。</p>
<p><img src="https://res.cloudinary.com/leon824/image/upload/v1535187828/kiaban_bozs2a.png" width="80%" height="80%"></p>
<p>我们将刚才创建的index加入到里边，然后点击<code>Discover</code>选择刚才配置的index，在选择时间，就能够看到数据已经被展示出来了。</p>
<p><img src="https://res.cloudinary.com/leon824/image/upload/v1535203571/discoey_g4ltbs.png" width="80%" height="80%"></p>
<p>上图中的左侧可以选择在右侧展示哪些字段。</p>
<h3 id="使用kibana绘图"><a href="#使用kibana绘图" class="headerlink" title="使用kibana绘图"></a>使用kibana绘图</h3><p>&emsp;&emsp;在kibana中也是可以完成一些绘图的，但是由于kibana没有相应权限控制，并且kibana的颜值是没有Grafana高，所以我们还是用Grafana来展示图表，kibana查询日志。下面就来探讨一下Grafana相关内容</p>
<hr>
<h2 id="Grafana相关"><a href="#Grafana相关" class="headerlink" title="Grafana相关"></a>Grafana相关</h2><p>我们先进入Grafana的<a href="https://grafana.com/grafana/download" target="_blank" rel="external">官网</a>，里边有介绍如何安装，也很简单。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;</span> wget https://s3-us-west-2.amazonaws.com/grafana-releases/release/grafana_5.2.2_amd64.deb </div><div class="line"><span class="meta">&gt;</span> sudo dpkg -i grafana_5.2.2_amd64.deb</div></pre></td></tr></table></figure>
<p>然后启动</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;</span> sudo /bin/systemctl start grafana-server</div></pre></td></tr></table></figure>
<p>访问<code>http://localhost:3000</code>然后使用admin登录进去，密码默认也是admin。进去后需要先配置数据源。</p>
<p><img src="https://res.cloudinary.com/leon824/image/upload/v1535204856/gra_ihk0b2.png" width="70%" height="70%"></p>
<p>  上边有几个地方需要注意：</p>
<ul>
<li>type：由于我们是使用ES作为数据源，所以这里一定要选择<code>elasticsearch</code></li>
<li>url : 连接elasticsearch服务的地址</li>
<li>Access：需要选择具体某种连接方式，两种方式是不同的，具体不同这里不详细描述</li>
<li>Auth：ES若是安装了相应密码权限，这里需要正确配置之后才能访问。</li>
<li>Index name ： 这里是填在ES中创建的index，但是要注意，若是index name包含了日志，那么后边的pattern就不要选择任何日期了。</li>
<li>Version ： 需要选择和安装的ES匹配的版本</li>
</ul>
<p>然后保存，然后就可以创建DashBoard、panel。grafana绘图、查询相关内容较多，后边若有时间还会探讨一下grafana绘图相关。</p>
<hr>
<h3 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h3><ul>
<li><a href="https://www.cnblogs.com/hupengcool/p/4031543.html" target="_blank" rel="external">elasticsearch 创建索引，以及检索一条数据</a></li>
<li><a href="https://grafana.com/grafana/download" target="_blank" rel="external">grafana官网</a></li>
<li><a href="https://groups.io/g/grafana/topic/tutorial_for_elasticsearch/716433?p=,,,20,0,0,0" target="_blank" rel="external">groups.io</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/08/22/ELK+KAFKA详解（一）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="leonyoung">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://res.cloudinary.com/leon824/image/upload/v1505793001/IMG_3957_uwrsum.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="花谢花开">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/08/22/ELK+KAFKA详解（一）/" itemprop="url">ELK+KAFKA详解（一）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              
              <time title="創建於" itemprop="dateCreated datePublished" datetime="2018-08-22T10:47:17+08:00">
                2018-08-22
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ELK/" itemprop="url" rel="index">
                    <span itemprop="name">ELK</span>
                  </a>
                </span>

                
                
              
            </span>
          

          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字數統計&#58;</span>
                
                <span title="字數統計">
                  2,637
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">閱讀時長 &asymp;</span>
                
                <span title="閱讀時長">
                  12
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>  <img src="https://res.cloudinary.com/leon824/image/upload/v1535599870/pic4_vjsn1u.jpg" width="80%" height="80%"></p>
<blockquote>
<p>&emsp;&emsp;日志，对于任何系统来说都是及其重要的组成部分。在计算机系统里面，更是如此。但是由于现在的计算机系统大多比较复杂，很多系统都不是在一个地方，甚至都是跨国界的；即使是在一个地方的系统，也有不同的来源，比如，操作系统，应用服务，业务逻辑等等。他们都在不停产生各种各样的日志数据。<br> &emsp;&emsp;根据不完全统计，我们全球每天大约要产生 2EB（1018）的数据。面对如此海量的数据，又是分布在各个不同地方，如果我们需要去查找一些重要的信息，难道还是使用传统的方法，去登陆到一台台机器上查看？看来传统的工具和方法已经显得非常笨拙和低效了。于是，一些聪明人就提出了建立一套集中式的方法，把不同来源的数据集中整合到一个地方。</p>
</blockquote>
<p>一个完整的集中式日志系统，是离不开以下几个主要特点的。</p>
<ul>
<li>收集－能够采集多种来源的日志数据</li>
<li>传输－能够稳定的把日志数据传输到中央系统</li>
<li>存储－如何存储日志数据</li>
<li>分析－可以支持 UI 分析</li>
<li>警告－能够提供错误报告，监控机制</li>
</ul>
<p>本文采用ELK + FILEBEAT + KAFKA的架构搭建日志收集系统。架构图如下：</p>
<p>  <img src="https://res.cloudinary.com/leon824/image/upload/v1535176986/geranal_eugyfc.png" width="80%" height="80%"></p>
<hr>
<h3 id="环境、版本"><a href="#环境、版本" class="headerlink" title="环境、版本"></a>环境、版本</h3><ul>
<li>JDK 1.8</li>
<li>OS : ubuntu18.04</li>
<li>filebeat、logstash、elasticsearch、kibana（5.5.3）</li>
<li>kafka_2.11-0.10.0.1</li>
<li>Grafana ：Latest version</li>
</ul>
<h3 id="filebeat安装"><a href="#filebeat安装" class="headerlink" title="filebeat安装"></a>filebeat安装</h3><blockquote>
<p>  &emsp;&emsp;一个轻量级开源日志文件数据搜集器，基于Logstash-Forwarder 源代码开发，是对它的替代。在需要采集日志数据的 server 上安装 Filebeat，并指定日志目录或日志文件后，Filebeat 就能读取数据，迅速发送到指定的MQ中，亦或直接发送到logstash进行过滤转发。<br>现下载到本地</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;</span> axel -n 5 https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-5.3.3-linux-x86_64.tar.gz</div><div class="line"><span class="meta">&gt;</span> tar -zxvf  filebeat-5.5.3-linux-x86_64.tar.gz</div><div class="line"><span class="meta">&gt;</span> mv filebeat-5.5.3-linux-x86_64 filebeat-5.5.3</div></pre></td></tr></table></figure>
<p>然后进入目录中复制一份cp filebeat.yml filebeat-kafka.yml，修改文件中相应的地方。</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#指定输入类型</span></div><div class="line"><span class="attr">- input_type:</span> <span class="string">log</span> </div><div class="line"><span class="comment"># 需要监控的文件目录，也可以使用通配符对整个目录监控</span></div><div class="line"><span class="attr">  paths:</span></div><div class="line"><span class="bullet">    -</span> <span class="string">/opt/soft/logs/platform.pro.access.log</span></div><div class="line"><span class="comment">#定义kafka为输出目的地</span></div><div class="line"><span class="string">output.kafka:</span></div><div class="line">  <span class="comment"># Array of hosts to connect to.</span></div><div class="line"><span class="attr">  hosts:</span> <span class="string">["ip:9092"]</span></div><div class="line">  <span class="comment">#kafka的主题</span></div><div class="line"><span class="attr">  topic:</span> <span class="string">nginx_log</span></div><div class="line">  </div><div class="line"><span class="attr">  processors:</span></div><div class="line"><span class="attr"> - drop_fields:</span></div><div class="line"><span class="attr">     fields:</span> <span class="string">["beat",</span> <span class="string">"input_type"</span><span class="string">,</span> <span class="string">"offset"</span><span class="string">,</span> <span class="string">"source"</span><span class="string">]</span></div></pre></td></tr></table></figure>
<p>需要特别注意的是上边<code>drop_fields</code>，可以在上边配置你不希望filebeat输入的字段（可以排除一些无用的信息，减少存储），可以添加<code>condition</code>条件，若是不添加条件，默认将所有声明的字段全部排除，不会将字段加入到输出流中。同时还要注意一定要将output输出目的从默认的<strong>ElasticSearch</strong>修改成<strong>kafka</strong>。 以上配置就算安装完成了。<br>接着启动.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;</span> ./filebeat -e -c filebeat-kafka.yml</div></pre></td></tr></table></figure>
<hr>
<h3 id="kafka安装配置"><a href="#kafka安装配置" class="headerlink" title="kafka安装配置"></a>kafka安装配置</h3><p>  kafka的运行依赖zookeeper，所以安装kafka之前需要先安装zookeeper，这里不用kafka自身带有的zookeeper。</p>
<h4 id="zookeeper配置"><a href="#zookeeper配置" class="headerlink" title="zookeeper配置"></a>zookeeper配置</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;</span> axel -n 5 https://archive.apache.org/dist/zookeeper/zookeeper-3.4.6/zookeeper-3.4.6.tar.gz</div><div class="line"><span class="meta">&gt;</span> tar -zxvf zookeeper-3.4.6.tar.gz</div></pre></td></tr></table></figure>
<p>  然后进入zookeeper目录创建两个文件夹</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;</span> mkdir logs</div><div class="line"><span class="meta">&gt;</span> mkdir data</div></pre></td></tr></table></figure>
<p>在/root/elk/zookeeper-3.4.6/conf目录下复制zoo_sample.cfg命名为zoo.cfg</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;</span> cp zoo_sample.cfg zoo.cfg</div></pre></td></tr></table></figure>
<p>  打开zoo.cfg，修改需要配置的地方</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">tickTime=2000</div><div class="line">initLimit=10</div><div class="line">syncLimit=5</div><div class="line">dataDir=/opt/soft/zookeeper-3.4.6/data</div><div class="line">dataLogDir=/opt/soft/zookeeper-3.4.6/logs</div><div class="line">clientPort=2181</div></pre></td></tr></table></figure>
<p>在/root/elk/zookeeper-3.4.6/data目录下创建一个myid文件。由于我们这里只是单点环境下，所以只需要在文件里边写入server.1。</p>
<p> 最后将zk的路径添加到相关的环境变量中，并添加PATH,然后启动</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;</span> zkServer.sh start</div></pre></td></tr></table></figure>
<p>最后查看zk是否启动成功</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;</span> zkServer.sh status</div></pre></td></tr></table></figure>
<h4 id="kafka配置"><a href="#kafka配置" class="headerlink" title="kafka配置"></a>kafka配置</h4><p>安装kafka的时候需要注意和logstash之间版本匹配的问题，logstash5.x以上必须使用kakfa 0.10以上版本，否则无法正常运行。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;</span> axel -n 5 https://archive.apache.org/dist/kafka/0.10.0.1/kafka_2.11-0.10.0.1.tgz</div></pre></td></tr></table></figure>
<p>下载完成之后解压、进入kafka根目录创建logs目录,然后打开config目录下的server.properties修改一些参数</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">log.dirs=/opt/soft/kafka_2.11-0.10.0.1/logs</div><div class="line">zookeeper.connect=ip:2181</div><div class="line">其他项根据需要自行修改....</div></pre></td></tr></table></figure>
<p>然后可以启动kafka</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;</span> bin/kafka-server-start.sh config/server.properties &amp;</div></pre></td></tr></table></figure>
<p>创建一个名叫nginx_log的kafka主题</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;</span> bin/kafka-topics.sh --create --zookeeper localhost:2181 --replication-factor 1 --partitions 1 --topic nginx_log</div></pre></td></tr></table></figure>
<p>然后自己可以尝试打开一个终端进入生产者模式，发送几条数据</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;</span> bin/kafka-console-producer.sh --broker-list localhost:9092 --topic nginx_log</div></pre></td></tr></table></figure>
<p>在另外一个终端中开启消费者模式，查看生产者发送的数据是否能够看到，若能正常看到发送的数据，说明kafka安装没有问题。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;</span> bin/kafka-console-consumer.sh --zookeeper localhost:2181 --topic nginx_log --from-beginning</div></pre></td></tr></table></figure>
<hr>
<h3 id="logstash安装配置"><a href="#logstash安装配置" class="headerlink" title="logstash安装配置"></a>logstash安装配置</h3><p> &emsp;&emsp;&ensp;记住文章开始的那张整体架构图，kafka是从filebeat接收数据，然后发送给logstash。所以这里logstash的input就是kafka了。<br> logstash是整个流程中配置、修改最多的一环，过程中也有一些坑。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;</span> axel -n 5 https://artifacts.elastic.co/downloads/logstash/logstash-5.3.3.tar.gz</div></pre></td></tr></table></figure>
<p>老规矩，先解压，进入config目录创建一个logstash.conf的文件，然后在这个文件里边添加input、filter、output三个模块。</p>
<h4 id="input模块"><a href="#input模块" class="headerlink" title="input模块"></a>input模块</h4><p>先来讲讲input模块，由于在logstash5.x中已经默认支持kafka作为input,所以可以直接使用。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">input&#123;</div><div class="line">    kafka&#123;</div><div class="line">       topics =&gt; ["nginx_log"]</div><div class="line">       type =&gt; "nginx-access"</div><div class="line">       bootstrap_servers =&gt; "ip:9092"</div><div class="line">       codec =&gt; "json"</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>topics :指定消费kafka的topic</li>
<li>type ： 若是logstash需要处理多个数据源，可以使用type来做后边过滤的区分。</li>
<li>bootstrap_servers ：kakfa服务的ip和端口号</li>
</ul>
<h4 id="filter模块"><a href="#filter模块" class="headerlink" title="filter模块"></a>filter模块</h4><p>&emsp;&emsp;&ensp; filter模块是具体处理数据的一个环节，当kafka的数据被input模块接收过来之后，接下来就会交给filter模块处理。这里我们是为了处理nginx的access日志，所以首先需要根据nginx的log_format来定制自己的grok正则表达式。<br>生产环境的log_format是下面这样👇</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">log_format</div><div class="line">        '$remote_addr [$time_local] $host "$request" '</div><div class="line">        '$status $body_bytes_sent "$http_referer" '</div><div class="line">        '"$http_x_forwarded_for" "$http_user_agent" $request_time $upstream_response_time';</div></pre></td></tr></table></figure>
<p>实际的日志长成这样 </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">100.116.224.17 [14/Aug/2018:07:45:49 +0800] platform.blingabc.com "POST /homeworkRecord/v1/insert HTTP/1.1" 200 517 "https://i.blingabc.com/home/read-book?stuID=11936" "27.187.252.91" "Mozilla/5.0 (iPhone; CPU iPhone OS 11_3 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Mobile/15E216 MicroMessenger/6.7.1 NetType/WIFI Language/zh_CN" 0.456 0.456</div></pre></td></tr></table></figure>
<p>&emsp;&emsp;&ensp;当我们在做nginx日志解析的时候，尽量复用grok自身带有的。少数不能解析的根据现有修改，基本上都满足解析nginx日志。在filter模块中加入下面的配置</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">grok &#123;</div><div class="line">      patterns_dir =&gt; <span class="string">"/opt/soft/logstash-5.5.3/patterns/nginx_pattern"</span> </div><div class="line">      match =&gt; &#123;</div><div class="line">         <span class="string">"message"</span> =&gt; <span class="string">"%&#123;NGINXACCESS&#125;"</span></div><div class="line">     &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>&emsp;&emsp;&ensp;需要注意上边的patterns_dir，这个路径中patterns这个目录必须创建在logstash的根目录中且只能叫这个名字，之后的nginx_pattern可以随意取。<br>nginx_pattern文件的内容：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">STATUS ([<span class="number">0</span>-<span class="number">9</span>.]&#123;<span class="number">0</span>,<span class="number">3</span>&#125;)</div><div class="line">REQUEST_TIME ([<span class="number">0</span>-<span class="number">9</span>.]&#123;<span class="number">0</span>,<span class="number">5</span>&#125;)</div><div class="line">FORWORD (?:%&#123;IPV4&#125;[,]?[ ]?)</div><div class="line">NGINXACCESS %&#123;IPV4:remote_addr&#125; \[%&#123;HTTPDATE:time_local&#125;\] (%&#123;HOSTNAME:host&#125;) (%&#123;QUOTEDSTRING:request&#125;) %&#123;STATUS:http_status&#125; %&#123;BASE10NUM:body_bytes_sent&#125; \<span class="string">"(?:%&#123;DATA:http_referer&#125;|-)\" \"(%&#123;FORWORD:http_x_forwarded_for&#125;|-)\" \"(%&#123;GREEDYDATA:user_agent&#125;|-)\" (%&#123;REQUEST_TIME:request_time&#125;|-) (%&#123;REQUEST_TIME:upstream_response_time&#125;|-)</span></div></pre></td></tr></table></figure>
<p>&emsp;&emsp;&ensp;其中前面三条是自己的定义的正则表达式，后边NGINXACCESS是整体解析nginx日志的表达式。在自己写解析日志的grok表达式的时候在<a href="https://grokdebug.herokuapp.com/" target="_blank" rel="external">Grok Debugger</a>中测试。</p>
<p><strong>最终解析出来的数据如下</strong> <em>【部分省略】</em></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"remote_addr"</span>: [</div><div class="line">    [</div><div class="line">      <span class="string">"100.116.224.72"</span></div><div class="line">    ]</div><div class="line">  ],</div><div class="line">  <span class="attr">"time_local"</span>: [</div><div class="line">    [</div><div class="line">      <span class="string">"14/Aug/2018:00:20:14 +0800"</span></div><div class="line">    ]</div><div class="line">  ],</div><div class="line">  <span class="attr">"host"</span>: [</div><div class="line">    [</div><div class="line">      <span class="string">"platform.blingabc.com"</span></div><div class="line">    ]</div><div class="line">  ],</div><div class="line">  <span class="attr">"request"</span>: [</div><div class="line">    [</div><div class="line">      <span class="string">""</span>OPTIONS /foreign/teacher/v1/login HTTP/<span class="number">1.1</span><span class="string">""</span></div><div class="line">    ]</div><div class="line">  ],</div><div class="line">  <span class="attr">"http_status"</span>: [</div><div class="line">    [</div><div class="line">      <span class="string">"200"</span></div><div class="line">    ]</div><div class="line">  ],</div><div class="line">  <span class="attr">"body_bytes_sent"</span>: [</div><div class="line">    [</div><div class="line">      <span class="string">"0"</span></div><div class="line">    ]</div><div class="line">  ],</div><div class="line">  <span class="attr">"http_referer"</span>: [</div><div class="line">    [</div><div class="line">      <span class="string">"-"</span></div><div class="line">    ]</div><div class="line">  ],</div><div class="line">  <span class="attr">"http_x_forwarded_for"</span>: [</div><div class="line">    [</div><div class="line">      <span class="string">"181.143.78.26"</span></div><div class="line">    ]</div><div class="line">  ],</div><div class="line">  <span class="attr">"user_agent"</span>: [</div><div class="line">    [</div><div class="line">      <span class="string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/68.0.3440.106 Safari/537.36"</span></div><div class="line">    ]</div><div class="line">  ],</div><div class="line">  <span class="attr">"request_time"</span>: [</div><div class="line">    [</div><div class="line">      <span class="string">"0.001"</span></div><div class="line">    ]</div><div class="line">  ],</div><div class="line">  <span class="attr">"upstream_response_time"</span>: [</div><div class="line">    [</div><div class="line">      <span class="string">"0.001"</span></div><div class="line">    ]</div><div class="line">  ]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>此时我们有一个需求，需要通过下面的request解析得到/foreign/teacher/v1/login和foreign，然后通过Grafana统计做top N展示，那么数据就还需要进一步拆分。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">"request": [</div><div class="line">    [</div><div class="line">      <span class="string">""</span>OPTIONS /foreign/teacher/v1/login HTTP/<span class="number">1.1</span><span class="string">""</span></div><div class="line">    ]</div><div class="line">  ],</div></pre></td></tr></table></figure>
<p>filter模块中支持很多插件给我们使用，例如grok、kv、ruby、mutate等等… 下面就用ruby和mutate来实现我们想达到的目标。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"> filter &#123;</div><div class="line">    grok &#123;</div><div class="line">          patterns_dir =&gt; <span class="string">"/opt/soft/logstash-5.5.3/patterns/nginx_pattern"</span> </div><div class="line">          match =&gt; &#123;</div><div class="line">             <span class="string">"message"</span> =&gt; <span class="string">"%&#123;NGINXACCESS&#125;"</span></div><div class="line">         &#125;</div><div class="line">      &#125;</div><div class="line">    <span class="keyword">if</span> [request] &#123;</div><div class="line">        ruby &#123;</div><div class="line">            init =&gt; <span class="string">"@kname = ['method','uri']"</span></div><div class="line">            code =&gt; <span class="string">"</span></div><div class="line"><span class="string">                new_event = LogStash::Event.new(Hash[@kname.zip(event.get('request').split(' '))]) </span></div><div class="line"><span class="string">                new_event.remove('@timestamp')</span></div><div class="line"><span class="string">                event.append(new_event)</span></div><div class="line"><span class="string">            "</span></div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> [uri] &#123;</div><div class="line">            ruby &#123;</div><div class="line">                init =&gt; <span class="string">"@kname = ['url_path','url_args']"</span></div><div class="line">                code =&gt; <span class="string">"</span></div><div class="line"><span class="string">                    new_event = LogStash::Event.new(Hash[@kname.zip(event.get('uri').split('?'))])</span></div><div class="line"><span class="string">                    new_event.remove('@timestamp')</span></div><div class="line"><span class="string">                    event.append(new_event)</span></div><div class="line"><span class="string">                "</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    </div><div class="line">   <span class="keyword">if</span> [url_path] &#123;</div><div class="line">            ruby &#123;</div><div class="line">                init =&gt; <span class="string">"@kname = ['service_name', 'url_path']"</span></div><div class="line">                code =&gt; <span class="string">"</span></div><div class="line"><span class="string">                    new_event = LogStash::Event.new(Hash[@kname.zip(event.get('uri').split('/'))])</span></div><div class="line"><span class="string">                    new_event.remove('@timestamp')</span></div><div class="line"><span class="string">                    event.append(new_event)</span></div><div class="line"><span class="string">                "</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;   </div><div class="line">    mutate &#123;</div><div class="line">            rename =&gt; [<span class="string">"url_path[1]"</span>, <span class="string">"service_name"</span>]</div><div class="line">	    rename =&gt; [<span class="string">"url_path[0]"</span>, <span class="string">"uri"</span>]</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> [service_name] == <span class="string">"monitor"</span> <span class="keyword">or</span> [service_name] == <span class="string">"weixin"</span> <span class="keyword">or</span> [method] == <span class="string">"OPTIONS"</span> &#123;</div><div class="line">            drop &#123;&#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上边的执行时流式执行的，就是说上边执行得到的结果下边可以直接使用。然后将数组里边的结果重名名，提供给下面ES使用。</p>
<h4 id="output"><a href="#output" class="headerlink" title="output"></a>output</h4><p>最后就是output模块了，这里比较简单，主要是讲过滤后的数据交给ES。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">output &#123;</div><div class="line">        elasticsearch&#123;</div><div class="line">        hosts =&gt; [<span class="string">"ip:9200"</span>]</div><div class="line">        index =&gt; <span class="string">"nginx-log"</span></div><div class="line">        template_overwrite =&gt; <span class="literal">true</span></div><div class="line">        template =&gt; <span class="string">"/opt/soft/logstash-5.5.3/output/es_template.json"</span></div><div class="line">        &#125;</div><div class="line">        stdout&#123;codec =&gt; rubydebug&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>但是需要注意上边的template指定的文件，在es_template.json这个文件中定义了filter模块解析出来的字段名称、类型。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="attr">"template"</span>:<span class="string">"nginx-log"</span>,</div><div class="line">    <span class="attr">"settings"</span>:&#123;</div><div class="line">        <span class="attr">"index.refresh_interval"</span>:<span class="string">"5s"</span>,</div><div class="line">        <span class="attr">"index.number_of_replicas"</span>:<span class="string">"1"</span></div><div class="line">    &#125;,</div><div class="line">    <span class="attr">"analysis"</span>:&#123;</div><div class="line">        <span class="attr">"analyzer"</span>:&#123;</div><div class="line">            <span class="attr">"default"</span>:&#123;</div><div class="line">                <span class="attr">"type"</span>:<span class="string">"standard"</span>,</div><div class="line">                <span class="attr">"stopwords"</span>:<span class="string">"_none_"</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">"mappings"</span>:&#123;</div><div class="line">        <span class="attr">"nginx_log"</span>:&#123;</div><div class="line">            <span class="attr">"_all"</span>:&#123;</div><div class="line">                <span class="attr">"enabled"</span>:<span class="literal">false</span></div><div class="line">            &#125;,</div><div class="line">            <span class="attr">"properties"</span>:&#123;</div><div class="line">                <span class="attr">"remote_addr"</span>:&#123;</div><div class="line">                    <span class="attr">"type"</span>:<span class="string">"ip"</span>,</div><div class="line">		    <span class="attr">"fielddata"</span>: <span class="literal">true</span></div><div class="line">                &#125;,</div><div class="line">                <span class="attr">"time_local"</span>:&#123;</div><div class="line">                    <span class="attr">"type"</span>:<span class="string">"date"</span>,</div><div class="line">                    <span class="attr">"format"</span>:<span class="string">"dd/MMM/yyyy:HH:mm:ss Z"</span></div><div class="line">                &#125;,</div><div class="line">                <span class="attr">"host"</span>:&#123;</div><div class="line">                    <span class="attr">"type"</span>:<span class="string">"string"</span>,</div><div class="line">		    <span class="attr">"fielddata"</span>: <span class="literal">true</span></div><div class="line">                &#125;,</div><div class="line">		<span class="attr">"uri"</span>:&#123;</div><div class="line">		    <span class="attr">"type"</span>:<span class="string">"string"</span>,</div><div class="line">		    <span class="attr">"fielddata"</span>: <span class="literal">true</span></div><div class="line">		&#125;,</div><div class="line">                <span class="attr">"request"</span>:&#123;</div><div class="line">                    <span class="attr">"type"</span>:<span class="string">"string"</span></div><div class="line">                &#125;,</div><div class="line">                <span class="attr">"http_status"</span>:&#123;</div><div class="line">                    <span class="attr">"type"</span>:<span class="string">"integer"</span>,</div><div class="line">		    <span class="attr">"fielddata"</span>: <span class="literal">true</span></div><div class="line">                &#125;,</div><div class="line">                <span class="attr">"body_bytes_sent"</span>:&#123;</div><div class="line">                    <span class="attr">"type"</span>:<span class="string">"integer"</span></div><div class="line">                &#125;,</div><div class="line">                <span class="attr">"http_referer"</span>:&#123;</div><div class="line">                    <span class="attr">"type"</span>:<span class="string">"string"</span></div><div class="line">                &#125;,</div><div class="line">                <span class="attr">"http_x_forwarded_for"</span>:&#123;</div><div class="line">                    <span class="attr">"type"</span>:<span class="string">"ip"</span></div><div class="line">                &#125;,</div><div class="line">                <span class="attr">"user_agent"</span>:&#123;</div><div class="line">                    <span class="attr">"type"</span>:<span class="string">"string"</span></div><div class="line">                &#125;,</div><div class="line">                <span class="attr">"request_time"</span>:&#123;</div><div class="line">                    <span class="attr">"type"</span>:<span class="string">"float"</span>,</div><div class="line">		    <span class="attr">"fielddata"</span>: <span class="literal">true</span></div><div class="line">                &#125;,</div><div class="line">                <span class="attr">"upstream_response_time"</span>:&#123;</div><div class="line">                    <span class="attr">"type"</span>:<span class="string">"float"</span></div><div class="line">                &#125;,</div><div class="line">                <span class="attr">"service_name"</span>:&#123;</div><div class="line">                    <span class="attr">"type"</span>:<span class="string">"string"</span>,</div><div class="line">		    <span class="attr">"fielddata"</span>: <span class="literal">true</span></div><div class="line">                &#125;,</div><div class="line">                <span class="attr">"request_url"</span>:&#123;</div><div class="line">                    <span class="attr">"type"</span>:<span class="string">"string"</span>,</div><div class="line">		    <span class="attr">"fielddata"</span>: <span class="literal">true</span></div><div class="line">                &#125;,</div><div class="line">                <span class="attr">"geoip"</span>:&#123;</div><div class="line">                    <span class="attr">"properties"</span>:&#123;</div><div class="line">                        <span class="attr">"city_name"</span>:&#123;</div><div class="line">                            <span class="attr">"type"</span>:<span class="string">"keyword"</span></div><div class="line">                        &#125;,</div><div class="line">                        <span class="attr">"country_name"</span>:&#123;</div><div class="line">                            <span class="attr">"type"</span>:<span class="string">"keyword"</span></div><div class="line">                        &#125;,</div><div class="line">                        <span class="attr">"latitude"</span>:&#123;</div><div class="line">                            <span class="attr">"type"</span>:<span class="string">"float"</span></div><div class="line">                        &#125;,</div><div class="line">                        <span class="attr">"location"</span>:&#123;</div><div class="line">                            <span class="attr">"type"</span>:<span class="string">"geo_point"</span></div><div class="line">                        &#125;,</div><div class="line">                        <span class="attr">"longitude"</span>:&#123;</div><div class="line">                            <span class="attr">"type"</span>:<span class="string">"float"</span></div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最终形成的配置文件就是这样的</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div></pre></td><td class="code"><pre><div class="line">input&#123;</div><div class="line">    kafka&#123;</div><div class="line">       topics =&gt; [<span class="string">"nginx_log"</span>]</div><div class="line">       type =&gt; <span class="string">"nginx-access"</span></div><div class="line">       bootstrap_servers =&gt; <span class="string">"ip:9092"</span></div><div class="line">       codec =&gt; <span class="string">"json"</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">filter &#123;</div><div class="line">    grok &#123;</div><div class="line">          patterns_dir =&gt; <span class="string">"/opt/soft/logstash-5.5.3/patterns/nginx_pattern"</span> </div><div class="line">          match =&gt; &#123;</div><div class="line">             <span class="string">"message"</span> =&gt; <span class="string">"%&#123;NGINXACCESS&#125;"</span></div><div class="line">         &#125;</div><div class="line">      &#125;</div><div class="line">    <span class="keyword">if</span> [request] &#123;</div><div class="line">        ruby &#123;</div><div class="line">            init =&gt; <span class="string">"@kname = ['method','uri']"</span></div><div class="line">            code =&gt; <span class="string">"</span></div><div class="line"><span class="string">                new_event = LogStash::Event.new(Hash[@kname.zip(event.get('request').split(' '))]) </span></div><div class="line"><span class="string">                new_event.remove('@timestamp')</span></div><div class="line"><span class="string">                event.append(new_event)</span></div><div class="line"><span class="string">            "</span></div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> [uri] &#123;</div><div class="line">            ruby &#123;</div><div class="line">                init =&gt; <span class="string">"@kname = ['url_path','url_args']"</span></div><div class="line">                code =&gt; <span class="string">"</span></div><div class="line"><span class="string">                    new_event = LogStash::Event.new(Hash[@kname.zip(event.get('uri').split('?'))])</span></div><div class="line"><span class="string">                    new_event.remove('@timestamp')</span></div><div class="line"><span class="string">                    event.append(new_event)</span></div><div class="line"><span class="string">                "</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    </div><div class="line">   <span class="keyword">if</span> [url_path] &#123;</div><div class="line">            ruby &#123;</div><div class="line">                init =&gt; <span class="string">"@kname = ['service_name', 'url_path']"</span></div><div class="line">                code =&gt; <span class="string">"</span></div><div class="line"><span class="string">                    new_event = LogStash::Event.new(Hash[@kname.zip(event.get('uri').split('/'))])</span></div><div class="line"><span class="string">                    new_event.remove('@timestamp')</span></div><div class="line"><span class="string">                    event.append(new_event)</span></div><div class="line"><span class="string">                "</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;   </div><div class="line">    mutate &#123;</div><div class="line">            rename =&gt; [<span class="string">"url_path[1]"</span>, <span class="string">"service_name"</span>]</div><div class="line">	    rename =&gt; [<span class="string">"url_path[0]"</span>, <span class="string">"uri"</span>]</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> [service_name] == <span class="string">"monitor"</span> <span class="keyword">or</span> [service_name] == <span class="string">"weixin"</span> <span class="keyword">or</span> [method] == <span class="string">"OPTIONS"</span> &#123;</div><div class="line">            drop &#123;&#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">output &#123;</div><div class="line">        elasticsearch&#123;</div><div class="line">        hosts =&gt; [<span class="string">"localhost:9200"</span>]</div><div class="line">        index =&gt; <span class="string">"nginx-log"</span></div><div class="line">        template_overwrite =&gt; <span class="literal">true</span></div><div class="line">        template =&gt; <span class="string">"/opt/soft/logstash-5.5.3/output/es_template.json"</span></div><div class="line">        &#125;</div><div class="line">	stdout&#123;codec =&gt; rubydebug&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上边已经整个环境搭建完成了一大半了，接下来就是安装Elasticsearch和kibana、Grafana。</p>
<h3 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h3><ul>
<li><a href="https://segmentfault.com/a/1190000011263254" target="_blank" rel="external">ELK初体验-Nginx日志实时分析</a></li>
<li><a href="http://blog.51cto.com/zero01/2079879" target="_blank" rel="external">搭建ELK日志分析平台（上）</a></li>
<li><a href="https://www.jianshu.com/p/6b7f0488ddff" target="_blank" rel="external">elk搭建实战</a></li>
<li><a href="https://my.oschina.net/itblog/blog/547250" target="_blank" rel="external">ELK(ElasticSearch, Logstash, Kibana)搭建实时日志分析平台</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/06/28/java 工程师成神之路(转载)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="leonyoung">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://res.cloudinary.com/leon824/image/upload/v1505793001/IMG_3957_uwrsum.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="花谢花开">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/28/java 工程师成神之路(转载)/" itemprop="url">java 工程师成神之路(转载)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              
              <time title="創建於" itemprop="dateCreated datePublished" datetime="2018-06-28T10:03:37+08:00">
                2018-06-28
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字數統計&#58;</span>
                
                <span title="字數統計">
                  2,579
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">閱讀時長 &asymp;</span>
                
                <span title="閱讀時長">
                  10
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>今天在论坛上看到的一个帖子，上边提到的内容极为宽泛，可能在短时间内不可能完全做到提到的所有内容，但也不妨作为一个学习的目标。<br><a href="https://www.v2ex.com/t/466451#reply2" target="_blank" rel="external">原文地址</a></p>
</blockquote>
<h3 id="基础篇"><a href="#基础篇" class="headerlink" title="基础篇"></a>基础篇</h3><h4 id="JVM"><a href="#JVM" class="headerlink" title="JVM"></a>JVM</h4><h5 id="JVM内存结构"><a href="#JVM内存结构" class="headerlink" title="JVM内存结构"></a>JVM内存结构</h5><p>堆、栈、方法区、直接内存、堆和栈区别</p>
<h5 id="Java-内存模型"><a href="#Java-内存模型" class="headerlink" title="Java 内存模型"></a>Java 内存模型</h5><p>内存可见性、重排序、顺序一致性、volatile、锁、final</p>
<h5 id="垃圾回收"><a href="#垃圾回收" class="headerlink" title="垃圾回收"></a>垃圾回收</h5><p>内存分配策略、垃圾收集器（ G1 ）、GC 算法、GC 参数、对象存活的判定</p>
<h5 id="JVM-参数及调优"><a href="#JVM-参数及调优" class="headerlink" title="JVM 参数及调优"></a>JVM 参数及调优</h5><h5 id="Java-对象模型"><a href="#Java-对象模型" class="headerlink" title="Java 对象模型"></a>Java 对象模型</h5><p>oop-klass、对象头</p>
<h5 id="HotSpot"><a href="#HotSpot" class="headerlink" title="HotSpot"></a>HotSpot</h5><p>即时编译器、编译优化</p>
<h5 id="类加载机制"><a href="#类加载机制" class="headerlink" title="类加载机制"></a>类加载机制</h5><p>classLoader、类加载过程、双亲委派（破坏双亲委派）、模块化（ jboss modules、osgi、jigsaw ）</p>
<h5 id="虚拟机性能监控与故障处理工具"><a href="#虚拟机性能监控与故障处理工具" class="headerlink" title="虚拟机性能监控与故障处理工具"></a>虚拟机性能监控与故障处理工具</h5><p> jps, jstack, jmap、jstat, jconsole, jinfo, jhat, javap, btrace、TProfiler</p>
<p>编译与反编译</p>
<p>javac、javap、jad、CRF</p>
<h4 id="Java-基础知识"><a href="#Java-基础知识" class="headerlink" title="Java 基础知识"></a>Java 基础知识</h4><h6 id="阅读源代码"><a href="#阅读源代码" class="headerlink" title="阅读源代码"></a>阅读源代码</h6><p>String、Integer、Long、Enum、BigDecimal、ThreadLocal、ClassLoader &amp; URLClassLoader、ArrayList &amp; LinkedList、HashMap &amp; LinkedHashMap &amp; TreeMap &amp; CouncurrentHashMap、HashSet &amp; LinkedHashSet &amp; TreeSet</p>
<h5 id="Java中各种变量类型"><a href="#Java中各种变量类型" class="headerlink" title="Java中各种变量类型"></a>Java中各种变量类型</h5><h5 id="熟悉-Java-String-的使用，熟悉-String-的各种函数"><a href="#熟悉-Java-String-的使用，熟悉-String-的各种函数" class="headerlink" title="熟悉 Java String 的使用，熟悉 String 的各种函数"></a>熟悉 Java String 的使用，熟悉 String 的各种函数</h5><p>JDK 6 和 JDK 7 中 substring 的原理及区别、</p>
<p>replaceFirst、replaceAll、replace 区别、</p>
<p>String 对“+”的重载、</p>
<p>String.valueOf 和 Integer.toString 的区别、</p>
<p>字符串的不可变性</p>
<p>自动拆装箱</p>
<p>Integer 的缓存机制</p>
<h5 id="熟悉-Java-中各种关键字"><a href="#熟悉-Java-中各种关键字" class="headerlink" title="熟悉 Java 中各种关键字"></a>熟悉 Java 中各种关键字</h5><p>transient、instanceof、volatile、synchronized、final、static、const 原理及用法。</p>
<h5 id="集合类"><a href="#集合类" class="headerlink" title="集合类"></a>集合类</h5><p>常用集合类的使用、ArrayList 和 LinkedList 和 Vector 的区别 、SynchronizedList 和 Vector 的区别、HashMap、HashTable、ConcurrentHashMap 区别、Java 8 中 stream 相关用法、apache 集合处理工具类的使用、不同版本的 JDK 中 HashMap 的实现的区别以及原因</p>
<h5 id="枚举"><a href="#枚举" class="headerlink" title="枚举"></a>枚举</h5><p>枚举的用法、枚举与单例、Enum 类</p>
<h5 id="Java-IO-amp-Java-NIO，并学会使用"><a href="#Java-IO-amp-Java-NIO，并学会使用" class="headerlink" title="Java IO&amp;Java NIO，并学会使用"></a>Java IO&amp;Java NIO，并学会使用</h5><p>bio、nio 和 aio 的区别、三种 IO 的用法与原理、netty</p>
<h5 id="Java-反射与-javassist"><a href="#Java-反射与-javassist" class="headerlink" title="Java 反射与 javassist"></a>Java 反射与 javassist</h5><p>反射与工厂模式、 java.lang.reflect.*</p>
<h5 id="Java-序列化"><a href="#Java-序列化" class="headerlink" title="Java 序列化"></a>Java 序列化</h5><p>什么是序列化与反序列化、为什么序列化、序列化底层原理、序列化与单例模式、protobuf、为什么说序列化并不安全</p>
<h5 id="注解"><a href="#注解" class="headerlink" title="注解"></a>注解</h5><p>元注解、自定义注解、Java 中常用注解使用、注解与反射的结合</p>
<h5 id="JMS"><a href="#JMS" class="headerlink" title="JMS"></a>JMS</h5><p>什么是 Java 消息服务、JMS 消息传送模型</p>
<h5 id="JMX"><a href="#JMX" class="headerlink" title="JMX"></a>JMX</h5><p>java.lang.management.<em>、 javax.management.</em></p>
<h4 id="泛型"><a href="#泛型" class="headerlink" title="泛型"></a>泛型</h4><p>泛型与继承、类型擦除、泛型中 K T V E ？ object 等的含义、泛型各种用法</p>
<h5 id="单元测试"><a href="#单元测试" class="headerlink" title="单元测试"></a>单元测试</h5><p>junit、mock、mockito、内存数据库（ h2 ）</p>
<h5 id="正则表达式"><a href="#正则表达式" class="headerlink" title="正则表达式"></a>正则表达式</h5><p>java.lang.util.regex.*</p>
<h5 id="常用的-Java-工具库"><a href="#常用的-Java-工具库" class="headerlink" title="常用的 Java 工具库"></a>常用的 Java 工具库</h5><p>commons.lang, commons.*… guava-libraries netty</p>
<h5 id="什么是-API-amp-SPI"><a href="#什么是-API-amp-SPI" class="headerlink" title="什么是 API&amp;SPI"></a>什么是 API&amp;SPI</h5><h5 id="异常"><a href="#异常" class="headerlink" title="异常"></a>异常</h5><p>异常类型、正确处理异常、自定义异常</p>
<h5 id="时间处理"><a href="#时间处理" class="headerlink" title="时间处理"></a>时间处理</h5><p>时区、时令、Java 中时间 API</p>
<h5 id="编码方式"><a href="#编码方式" class="headerlink" title="编码方式"></a>编码方式</h5><p>解决乱码问题、常用编码方式</p>
<h5 id="语法糖"><a href="#语法糖" class="headerlink" title="语法糖"></a>语法糖</h5><p>Java 中语法糖原理、解语法糖</p>
<h4 id="Java-并发编程"><a href="#Java-并发编程" class="headerlink" title="Java 并发编程"></a>Java 并发编程</h4><h5 id="什么是线程，与进程的区别"><a href="#什么是线程，与进程的区别" class="headerlink" title="什么是线程，与进程的区别"></a>什么是线程，与进程的区别</h5><h5 id="阅读源代码，并学会使用"><a href="#阅读源代码，并学会使用" class="headerlink" title="阅读源代码，并学会使用"></a>阅读源代码，并学会使用</h5><p>Thread、Runnable、Callable、ReentrantLock、ReentrantReadWriteLock、Atomic*、Semaphore、CountDownLatch、、ConcurrentHashMap、Executors</p>
<h5 id="线程池"><a href="#线程池" class="headerlink" title="线程池"></a>线程池</h5><p>自己设计线程池、submit() 和 execute()</p>
<h5 id="线程安全"><a href="#线程安全" class="headerlink" title="线程安全"></a>线程安全</h5><p>死锁、死锁如何排查、Java 线程调度、线程安全和内存模型的关系</p>
<h5 id="锁"><a href="#锁" class="headerlink" title="锁"></a>锁</h5><p>CAS、乐观锁与悲观锁、数据库相关锁机制、分布式锁、偏向锁、轻量级锁、重量级锁、monitor、锁优化、锁消除、锁粗化、自旋锁、可重入锁、阻塞锁、死锁</p>
<h5 id="死锁"><a href="#死锁" class="headerlink" title="死锁"></a>死锁</h5><h5 id="volatile"><a href="#volatile" class="headerlink" title="volatile"></a>volatile</h5><h5 id="happens-before、编译器指令重排和-CPU-指令重"><a href="#happens-before、编译器指令重排和-CPU-指令重" class="headerlink" title="happens-before、编译器指令重排和 CPU 指令重"></a>happens-before、编译器指令重排和 CPU 指令重</h5><h5 id="synchronized"><a href="#synchronized" class="headerlink" title="synchronized"></a>synchronized</h5><p>synchronized 是如何实现的？ synchronized 和 lock 之间关系、不使用 synchronized 如何实现一个线程安全的单例</p>
<h5 id="sleep-和-wait"><a href="#sleep-和-wait" class="headerlink" title="sleep 和 wait"></a>sleep 和 wait</h5><h5 id="wait-和-notify"><a href="#wait-和-notify" class="headerlink" title="wait 和 notify"></a>wait 和 notify</h5><h5 id="notify-和-notifyAll"><a href="#notify-和-notifyAll" class="headerlink" title="notify 和 notifyAll"></a>notify 和 notifyAll</h5><h5 id="ThreadLocal"><a href="#ThreadLocal" class="headerlink" title="ThreadLocal"></a>ThreadLocal</h5><h5 id="写一个死锁的程序"><a href="#写一个死锁的程序" class="headerlink" title="写一个死锁的程序"></a>写一个死锁的程序</h5><h5 id="写代码来解决生产者消费者问题"><a href="#写代码来解决生产者消费者问题" class="headerlink" title="写代码来解决生产者消费者问题"></a>写代码来解决生产者消费者问题</h5><h5 id="守护线程"><a href="#守护线程" class="headerlink" title="守护线程"></a>守护线程</h5><h5 id="守护线程和非守护线程的区别以及用法"><a href="#守护线程和非守护线程的区别以及用法" class="headerlink" title="守护线程和非守护线程的区别以及用法"></a>守护线程和非守护线程的区别以及用法</h5><h3 id="进阶篇"><a href="#进阶篇" class="headerlink" title="进阶篇"></a>进阶篇</h3><h4 id="Java-底层知识"><a href="#Java-底层知识" class="headerlink" title="Java 底层知识"></a>Java 底层知识</h4><h5 id="字节码、class-文件格式"><a href="#字节码、class-文件格式" class="headerlink" title="字节码、class 文件格式"></a>字节码、class 文件格式</h5><h5 id="CPU-缓存，L1，L2，L3-和伪共享"><a href="#CPU-缓存，L1，L2，L3-和伪共享" class="headerlink" title="CPU 缓存，L1，L2，L3 和伪共享"></a>CPU 缓存，L1，L2，L3 和伪共享</h5><h5 id="尾递归"><a href="#尾递归" class="headerlink" title="尾递归"></a>尾递归</h5><h5 id="位运算"><a href="#位运算" class="headerlink" title="位运算"></a>位运算</h5><h5 id="用位运算实现加、减、乘、除、取余"><a href="#用位运算实现加、减、乘、除、取余" class="headerlink" title="用位运算实现加、减、乘、除、取余"></a>用位运算实现加、减、乘、除、取余</h5><h4 id="设计模式"><a href="#设计模式" class="headerlink" title="设计模式"></a>设计模式</h4><h5 id="了解-23-种设计模式"><a href="#了解-23-种设计模式" class="headerlink" title="了解 23 种设计模式"></a>了解 23 种设计模式</h5><p>会使用常用设计模式<br>单例、策略、工厂、适配器、责任链。</p>
<h5 id="实现-AOP"><a href="#实现-AOP" class="headerlink" title="实现 AOP"></a>实现 AOP</h5><h5 id="实现-IOC"><a href="#实现-IOC" class="headerlink" title="实现 IOC"></a>实现 IOC</h5><h5 id="不用-synchronized-和-lock，实现线程安全的单例模式"><a href="#不用-synchronized-和-lock，实现线程安全的单例模式" class="headerlink" title="不用 synchronized 和 lock，实现线程安全的单例模式"></a>不用 synchronized 和 lock，实现线程安全的单例模式</h5><h5 id="nio-和-reactor-设计模式"><a href="#nio-和-reactor-设计模式" class="headerlink" title="nio 和 reactor 设计模式"></a>nio 和 reactor 设计模式</h5><h4 id="网络编程知识"><a href="#网络编程知识" class="headerlink" title="网络编程知识"></a>网络编程知识</h4><h5 id="tcp、udp、http、https-等常用协议"><a href="#tcp、udp、http、https-等常用协议" class="headerlink" title="tcp、udp、http、https 等常用协议"></a>tcp、udp、http、https 等常用协议</h5><p>三次握手与四次关闭、流量控制和拥塞控制、OSI 七层模型、tcp 粘包与拆包</p>
<h5 id="http-1-0-http-1-1-http-2-之前的区别"><a href="#http-1-0-http-1-1-http-2-之前的区别" class="headerlink" title="http/1.0 http/1.1 http/2 之前的区别"></a>http/1.0 http/1.1 http/2 之前的区别</h5><h5 id="Java-RMI，Socket，HttpClient"><a href="#Java-RMI，Socket，HttpClient" class="headerlink" title="Java RMI，Socket，HttpClient"></a>Java RMI，Socket，HttpClient</h5><h5 id="cookie-与-session"><a href="#cookie-与-session" class="headerlink" title="cookie 与 session"></a>cookie 与 session</h5><p>cookie 被禁用，如何实现 session</p>
<h5 id="用-Java-写一个简单的静态文件的-HTTP-服务器"><a href="#用-Java-写一个简单的静态文件的-HTTP-服务器" class="headerlink" title="用 Java 写一个简单的静态文件的 HTTP 服务器"></a>用 Java 写一个简单的静态文件的 HTTP 服务器</h5><p>实现客户端缓存功能，支持返回 304 实现可并发下载一个文件 使用线程池处理客户端请求 使用 nio 处理客户端请求 支持简单的 rewrite 规则 上述功能在实现的时候需要满足“开闭原则”</p>
<h5 id="了解-nginx-和-apache-服务器的特性并搭建一个对应的服务器"><a href="#了解-nginx-和-apache-服务器的特性并搭建一个对应的服务器" class="headerlink" title="了解 nginx 和 apache 服务器的特性并搭建一个对应的服务器"></a>了解 nginx 和 apache 服务器的特性并搭建一个对应的服务器</h5><h5 id="用-Java-实现-FTP、SMTP-协议"><a href="#用-Java-实现-FTP、SMTP-协议" class="headerlink" title="用 Java 实现 FTP、SMTP 协议"></a>用 Java 实现 FTP、SMTP 协议</h5><h5 id="进程间通讯的方式"><a href="#进程间通讯的方式" class="headerlink" title="进程间通讯的方式"></a>进程间通讯的方式</h5><h5 id="什么是-CDN-？如果实现？"><a href="#什么是-CDN-？如果实现？" class="headerlink" title="什么是 CDN ？如果实现？"></a>什么是 CDN ？如果实现？</h5><h5 id="什么是-DNS-？"><a href="#什么是-DNS-？" class="headerlink" title="什么是 DNS ？"></a>什么是 DNS ？</h5><h5 id="反向代理"><a href="#反向代理" class="headerlink" title="反向代理"></a>反向代理</h5><h4 id="框架知识"><a href="#框架知识" class="headerlink" title="框架知识"></a>框架知识</h4><h5 id="Servlet-线程安全问题"><a href="#Servlet-线程安全问题" class="headerlink" title="Servlet 线程安全问题"></a>Servlet 线程安全问题</h5><h5 id="Servlet-中的-filter-和-listener"><a href="#Servlet-中的-filter-和-listener" class="headerlink" title="Servlet 中的 filter 和 listener"></a>Servlet 中的 filter 和 listener</h5><h5 id="Hibernate-的缓存机制"><a href="#Hibernate-的缓存机制" class="headerlink" title="Hibernate 的缓存机制"></a>Hibernate 的缓存机制</h5><h5 id="Hiberate-的懒加载"><a href="#Hiberate-的懒加载" class="headerlink" title="Hiberate 的懒加载"></a>Hiberate 的懒加载</h5><h5 id="Spring-Bean-的初始化"><a href="#Spring-Bean-的初始化" class="headerlink" title="Spring Bean 的初始化"></a>Spring Bean 的初始化</h5><h5 id="Spring-的-AOP-原理"><a href="#Spring-的-AOP-原理" class="headerlink" title="Spring 的 AOP 原理"></a>Spring 的 AOP 原理</h5><h5 id="自己实现-Spring-的-IOC"><a href="#自己实现-Spring-的-IOC" class="headerlink" title="自己实现 Spring 的 IOC"></a>自己实现 Spring 的 IOC</h5><h5 id="Spring-MVC"><a href="#Spring-MVC" class="headerlink" title="Spring MVC"></a>Spring MVC</h5><h5 id="Spring-Boot2-0"><a href="#Spring-Boot2-0" class="headerlink" title="Spring Boot2.0"></a>Spring Boot2.0</h5><h5 id="Spring-Boot-的-starter-原理，自己实现一个-starter"><a href="#Spring-Boot-的-starter-原理，自己实现一个-starter" class="headerlink" title="Spring Boot 的 starter 原理，自己实现一个 starter"></a>Spring Boot 的 starter 原理，自己实现一个 starter</h5><h5 id="Spring-Security"><a href="#Spring-Security" class="headerlink" title="Spring Security"></a>Spring Security</h5><p>应用服务器知识</p>
<h5 id="JBoss"><a href="#JBoss" class="headerlink" title="JBoss"></a>JBoss</h5><h5 id="tomcat"><a href="#tomcat" class="headerlink" title="tomcat"></a>tomcat</h5><h5 id="jetty"><a href="#jetty" class="headerlink" title="jetty"></a>jetty</h5><h5 id="Weblogic"><a href="#Weblogic" class="headerlink" title="Weblogic"></a>Weblogic</h5><h4 id="工具"><a href="#工具" class="headerlink" title="工具"></a>工具</h4><h5 id="git-amp-svn"><a href="#git-amp-svn" class="headerlink" title="git &amp; svn"></a>git &amp; svn</h5><h5 id="maven-amp-gradle"><a href="#maven-amp-gradle" class="headerlink" title="maven &amp; gradle"></a>maven &amp; gradle</h5><h4 id="idea"><a href="#idea" class="headerlink" title="idea"></a>idea</h4><h3 id="高级篇"><a href="#高级篇" class="headerlink" title="高级篇"></a>高级篇</h3><h4 id="新技术"><a href="#新技术" class="headerlink" title="新技术"></a>新技术</h4><h5 id="java8"><a href="#java8" class="headerlink" title="java8"></a>java8</h5><p> lambda 表达式、Stream API、</p>
<h5 id="Java-9"><a href="#Java-9" class="headerlink" title="Java 9"></a>Java 9</h5><p>Jigsaw、Jshell、Reactive Streams</p>
<h5 id="Java-10"><a href="#Java-10" class="headerlink" title="Java 10"></a>Java 10</h5><p>局部变量类型推断、G1 的并行 Full GC、ThreadLocal 握手机制</p>
<h5 id="Spring-5"><a href="#Spring-5" class="headerlink" title="Spring 5"></a>Spring 5</h5><p>响应式编程</p>
<h5 id="Spring-Boot-2-0"><a href="#Spring-Boot-2-0" class="headerlink" title="Spring Boot 2.0"></a>Spring Boot 2.0</h5><p>性能优化<br>使用单例、使用 Future 模式、使用线程池、选择就绪、减少上下文切换、减少锁粒度、数据压缩、结果缓存</p>
<h4 id="线上问题分析"><a href="#线上问题分析" class="headerlink" title="线上问题分析"></a>线上问题分析</h4><h5 id="dump-获取"><a href="#dump-获取" class="headerlink" title="dump 获取"></a>dump 获取</h5><p>线程 Dump、内存 Dump、gc 情况</p>
<h5 id="dump-分析"><a href="#dump-分析" class="headerlink" title="dump 分析"></a>dump 分析</h5><p>分析死锁、分析内存泄露</p>
<h5 id="自己编写各种-outofmemory，stackoverflow-程序"><a href="#自己编写各种-outofmemory，stackoverflow-程序" class="headerlink" title="自己编写各种 outofmemory，stackoverflow 程序"></a>自己编写各种 outofmemory，stackoverflow 程序</h5><p>HeapOutOfMemory、Young OutOfMemory、MethodArea OutOfMemory、ConstantPool OutOfMemory、DirectMemory OutOfMemory、Stack OutOfMemory Stack OverFlow</p>
<h5 id="常见问题解决思路"><a href="#常见问题解决思路" class="headerlink" title="常见问题解决思路"></a>常见问题解决思路</h5><p>内存溢出、线程死锁、类加载冲突</p>
<h5 id="使用工具尝试解决以下问题，并写下总结"><a href="#使用工具尝试解决以下问题，并写下总结" class="headerlink" title="使用工具尝试解决以下问题，并写下总结"></a>使用工具尝试解决以下问题，并写下总结</h5><p>当一个 Java 程序响应很慢时如何查找问题、</p>
<p>当一个 Java 程序频繁 FullGC 时如何解决问题、</p>
<p>如何查看垃圾回收日志、</p>
<p>当一个 Java 应用发生 OutOfMemory 时该如何解决、</p>
<p>如何判断是否出现死锁、</p>
<p>如何判断是否存在内存泄露</p>
<h4 id="编译原理知识"><a href="#编译原理知识" class="headerlink" title="编译原理知识"></a>编译原理知识</h4><h5 id="编译与反编译"><a href="#编译与反编译" class="headerlink" title="编译与反编译"></a>编译与反编译</h5><h5 id="Java-代码的编译与反编译"><a href="#Java-代码的编译与反编译" class="headerlink" title="Java 代码的编译与反编译"></a>Java 代码的编译与反编译</h5><h5 id="Java-的反编译工具"><a href="#Java-的反编译工具" class="headerlink" title="Java 的反编译工具"></a>Java 的反编译工具</h5><h5 id="词法分析，语法分析（-LL-算法，递归下降算法，LR-算法），语义分析，运行时环境，中间代码，代码生成，代码优化"><a href="#词法分析，语法分析（-LL-算法，递归下降算法，LR-算法），语义分析，运行时环境，中间代码，代码生成，代码优化" class="headerlink" title="词法分析，语法分析（ LL 算法，递归下降算法，LR 算法），语义分析，运行时环境，中间代码，代码生成，代码优化"></a>词法分析，语法分析（ LL 算法，递归下降算法，LR 算法），语义分析，运行时环境，中间代码，代码生成，代码优化</h5><h4 id="操作系统知识"><a href="#操作系统知识" class="headerlink" title="操作系统知识"></a>操作系统知识</h4><h5 id="Linux-的常用命令"><a href="#Linux-的常用命令" class="headerlink" title="Linux 的常用命令"></a>Linux 的常用命令</h5><h5 id="进程同步"><a href="#进程同步" class="headerlink" title="进程同步"></a>进程同步</h5><h5 id="缓冲区溢出"><a href="#缓冲区溢出" class="headerlink" title="缓冲区溢出"></a>缓冲区溢出</h5><h5 id="分段和分页"><a href="#分段和分页" class="headerlink" title="分段和分页"></a>分段和分页</h5><h5 id="虚拟内存与主存"><a href="#虚拟内存与主存" class="headerlink" title="虚拟内存与主存"></a>虚拟内存与主存</h5><h4 id="数据库知识"><a href="#数据库知识" class="headerlink" title="数据库知识"></a>数据库知识</h4><h5 id="MySql-执行引擎"><a href="#MySql-执行引擎" class="headerlink" title="MySql 执行引擎"></a>MySql 执行引擎</h5><h5 id="MySQL-执行计划"><a href="#MySQL-执行计划" class="headerlink" title="MySQL 执行计划"></a>MySQL 执行计划</h5><h5 id="如何查看执行计划，如何根据执行计划进行-SQL-优化"><a href="#如何查看执行计划，如何根据执行计划进行-SQL-优化" class="headerlink" title="如何查看执行计划，如何根据执行计划进行 SQL 优化"></a>如何查看执行计划，如何根据执行计划进行 SQL 优化</h5><h4 id="SQL-优化"><a href="#SQL-优化" class="headerlink" title="SQL 优化"></a>SQL 优化</h4><h5 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h5><p>事务的隔离级别、事务能不能实现锁的功能</p>
<h5 id="数据库锁"><a href="#数据库锁" class="headerlink" title="数据库锁"></a>数据库锁</h5><p>行锁、表锁、使用数据库锁实现乐观锁、</p>
<h5 id="数据库主备搭建"><a href="#数据库主备搭建" class="headerlink" title="数据库主备搭建"></a>数据库主备搭建</h5><h5 id="binlog"><a href="#binlog" class="headerlink" title="binlog"></a>binlog</h5><h5 id="内存数据库"><a href="#内存数据库" class="headerlink" title="内存数据库"></a>内存数据库</h5><p>h2</p>
<h5 id="常用的-nosql-数据库"><a href="#常用的-nosql-数据库" class="headerlink" title="常用的 nosql 数据库"></a>常用的 nosql 数据库</h5><p>redis、memcached</p>
<h5 id="分别使用数据库锁、NoSql-实现分布式锁"><a href="#分别使用数据库锁、NoSql-实现分布式锁" class="headerlink" title="分别使用数据库锁、NoSql 实现分布式锁"></a>分别使用数据库锁、NoSql 实现分布式锁</h5><h5 id="性能调优"><a href="#性能调优" class="headerlink" title="性能调优"></a>性能调优</h5><h4 id="数据结构与算法知识"><a href="#数据结构与算法知识" class="headerlink" title="数据结构与算法知识"></a>数据结构与算法知识</h4><h5 id="简单的数据结构"><a href="#简单的数据结构" class="headerlink" title="简单的数据结构"></a>简单的数据结构</h5><h5 id="栈、队列、链表、数组、哈希表、"><a href="#栈、队列、链表、数组、哈希表、" class="headerlink" title="栈、队列、链表、数组、哈希表、"></a>栈、队列、链表、数组、哈希表、</h5><h5 id="树"><a href="#树" class="headerlink" title="树"></a>树</h5><p>二叉树、字典树、平衡树、排序树、B 树、B+树、R 树、多路树、红黑树</p>
<h5 id="排序算法"><a href="#排序算法" class="headerlink" title="排序算法"></a>排序算法</h5><p>各种排序算法和时间复杂度 深度优先和广度优先搜索 全排列、贪心算法、KMP 算法、hash 算法、海量数据处理</p>
<h4 id="大数据知识"><a href="#大数据知识" class="headerlink" title="大数据知识"></a>大数据知识</h4><h5 id="Zookeeper"><a href="#Zookeeper" class="headerlink" title="Zookeeper"></a>Zookeeper</h5><p>基本概念、常见用法</p>
<h5 id="Solr，Lucene，ElasticSearch"><a href="#Solr，Lucene，ElasticSearch" class="headerlink" title="Solr，Lucene，ElasticSearch"></a>Solr，Lucene，ElasticSearch</h5><p>在 linux 上部署 solr，solrcloud，，新增、删除、查询索引</p>
<h5 id="Storm，流式计算，了解-Spark，S4"><a href="#Storm，流式计算，了解-Spark，S4" class="headerlink" title="Storm，流式计算，了解 Spark，S4"></a>Storm，流式计算，了解 Spark，S4</h5><p>在 linux 上部署 storm，用 zookeeper 做协调，运行 storm hello world，local 和 remote 模式运行调试 storm topology。</p>
<h5 id="Hadoop，离线计算"><a href="#Hadoop，离线计算" class="headerlink" title="Hadoop，离线计算"></a>Hadoop，离线计算</h5><p>HDFS、MapReduce</p>
<h5 id="分布式日志收集-flume，kafka，logstash"><a href="#分布式日志收集-flume，kafka，logstash" class="headerlink" title="分布式日志收集 flume，kafka，logstash"></a>分布式日志收集 flume，kafka，logstash</h5><h5 id="数据挖掘，mahout"><a href="#数据挖掘，mahout" class="headerlink" title="数据挖掘，mahout"></a>数据挖掘，mahout</h5><h4 id="网络安全知识"><a href="#网络安全知识" class="headerlink" title="网络安全知识"></a>网络安全知识</h4><h5 id="什么是-XSS"><a href="#什么是-XSS" class="headerlink" title="什么是 XSS"></a>什么是 XSS</h5><p>XSS 的防御</p>
<h5 id="什么是-CSRF"><a href="#什么是-CSRF" class="headerlink" title="什么是 CSRF"></a>什么是 CSRF</h5><h5 id="什么是注入攻击"><a href="#什么是注入攻击" class="headerlink" title="什么是注入攻击"></a>什么是注入攻击</h5><p>SQL 注入、XML 注入、CRLF 注入</p>
<h5 id="什么是文件上传漏洞"><a href="#什么是文件上传漏洞" class="headerlink" title="什么是文件上传漏洞"></a>什么是文件上传漏洞</h5><h5 id="加密与解密"><a href="#加密与解密" class="headerlink" title="加密与解密"></a>加密与解密</h5><p>MD5，SHA1、DES、AES、RSA、DSA</p>
<h5 id="什么是-DOS-攻击和-DDOS-攻击"><a href="#什么是-DOS-攻击和-DDOS-攻击" class="headerlink" title="什么是 DOS 攻击和 DDOS 攻击"></a>什么是 DOS 攻击和 DDOS 攻击</h5><p>memcached 为什么可以导致 DDos 攻击、什么是反射型 DDoS</p>
<h5 id="SSL、TLS，HTTPS"><a href="#SSL、TLS，HTTPS" class="headerlink" title="SSL、TLS，HTTPS"></a>SSL、TLS，HTTPS</h5><h5 id="如何通过-Hash-碰撞进行-DOS-攻击"><a href="#如何通过-Hash-碰撞进行-DOS-攻击" class="headerlink" title="如何通过 Hash 碰撞进行 DOS 攻击"></a>如何通过 Hash 碰撞进行 DOS 攻击</h5><h5 id="用-openssl-签一个证书部署到-apache-或-nginx"><a href="#用-openssl-签一个证书部署到-apache-或-nginx" class="headerlink" title="用 openssl 签一个证书部署到 apache 或 nginx"></a>用 openssl 签一个证书部署到 apache 或 nginx</h5><h3 id="四、架构篇"><a href="#四、架构篇" class="headerlink" title="四、架构篇"></a>四、架构篇</h3><h5 id="分布式"><a href="#分布式" class="headerlink" title="分布式"></a>分布式</h5><p>数据一致性、服务治理、服务降级</p>
<h5 id="分布式事务"><a href="#分布式事务" class="headerlink" title="分布式事务"></a>分布式事务</h5><p>2PC、3PC、CAP、BASE、 可靠消息最终一致性、最大努力通知、TCC</p>
<h5 id="Dubbo"><a href="#Dubbo" class="headerlink" title="Dubbo"></a>Dubbo</h5><p>服务注册、服务发现，服务治理</p>
<h5 id="分布式数据库"><a href="#分布式数据库" class="headerlink" title="分布式数据库"></a>分布式数据库</h5><p>怎样打造一个分布式数据库、什么时候需要分布式数据库、mycat、otter、HBase</p>
<h5 id="分布式文件系统"><a href="#分布式文件系统" class="headerlink" title="分布式文件系统"></a>分布式文件系统</h5><p>mfs、fastdfs</p>
<h5 id="分布式缓存"><a href="#分布式缓存" class="headerlink" title="分布式缓存"></a>分布式缓存</h5><p>缓存一致性、缓存命中率、缓存冗余</p>
<h4 id="微服务"><a href="#微服务" class="headerlink" title="微服务"></a>微服务</h4><p>SOA、康威定律</p>
<h5 id="ServiceMesh"><a href="#ServiceMesh" class="headerlink" title="ServiceMesh"></a>ServiceMesh</h5><h5 id="Docker-amp-Kubernets"><a href="#Docker-amp-Kubernets" class="headerlink" title="Docker &amp; Kubernets"></a>Docker &amp; Kubernets</h5><h5 id="Spring-Boot"><a href="#Spring-Boot" class="headerlink" title="Spring Boot"></a>Spring Boot</h5><h5 id="Spring-Cloud"><a href="#Spring-Cloud" class="headerlink" title="Spring Cloud"></a>Spring Cloud</h5><h4 id="高并发"><a href="#高并发" class="headerlink" title="高并发"></a>高并发</h4><h5 id="分库分表"><a href="#分库分表" class="headerlink" title="分库分表"></a>分库分表</h5><h5 id="分库分表-1"><a href="#分库分表-1" class="headerlink" title="分库分表"></a>分库分表</h5><h5 id="CDN-技术"><a href="#CDN-技术" class="headerlink" title="CDN 技术"></a>CDN 技术</h5><h5 id="消息队列"><a href="#消息队列" class="headerlink" title="消息队列"></a>消息队列</h5><p>ActiveMQ、RabbitMQ、Kafka</p>
<h4 id="监控"><a href="#监控" class="headerlink" title="监控"></a>监控</h4><h5 id="监控什么"><a href="#监控什么" class="headerlink" title="监控什么"></a>监控什么</h5><p>CPU、内存、磁盘 I/O、网络 I/O 等</p>
<h5 id="监控手段"><a href="#监控手段" class="headerlink" title="监控手段"></a>监控手段</h5><p>进程监控、语义监控、机器资源监控、数据波动</p>
<h5 id="监控数据采集"><a href="#监控数据采集" class="headerlink" title="监控数据采集"></a>监控数据采集</h5><p>日志、埋点</p>
<h5 id="Dapper"><a href="#Dapper" class="headerlink" title="Dapper"></a>Dapper</h5><h5 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h5><p>tomcat 负载均衡、Nginx 负载均衡</p>
<h5 id="DNS"><a href="#DNS" class="headerlink" title="DNS"></a>DNS</h5><p>DNS 原理、DNS 的设计</p>
<h5 id="CDN"><a href="#CDN" class="headerlink" title="CDN"></a>CDN</h5><h5 id="数据一致性"><a href="#数据一致性" class="headerlink" title="数据一致性"></a>数据一致性</h5><h3 id="五、-扩展篇"><a href="#五、-扩展篇" class="headerlink" title="五、 扩展篇"></a>五、 扩展篇</h3><h4 id="云计算"><a href="#云计算" class="headerlink" title="云计算"></a>云计算</h4><p>IaaS、SaaS、PaaS、虚拟化技术、openstack、Serverlsess</p>
<h5 id="搜索引擎"><a href="#搜索引擎" class="headerlink" title="搜索引擎"></a>搜索引擎</h5><p>Solr、Lucene、Nutch、Elasticsearch</p>
<h5 id="权限管理"><a href="#权限管理" class="headerlink" title="权限管理"></a>权限管理</h5><p>Shiro</p>
<h5 id="区块链"><a href="#区块链" class="headerlink" title="区块链"></a>区块链</h5><p>哈希算法、Merkle 树、公钥密码算法、共识算法、Raft 协议、Paxos 算法与 Raft 算法、拜占庭问题与算法、消息认证码与数字签名</p>
<h5 id="比特币"><a href="#比特币" class="headerlink" title="比特币"></a>比特币</h5><p>挖矿、共识机制、闪电网络、侧链、热点问题、分叉</p>
<h5 id="以太坊"><a href="#以太坊" class="headerlink" title="以太坊"></a>以太坊</h5><p>超级账本<br>人工智能<br>数学基础、机器学习、人工神经网络、深度学习、应用场景。</p>
<h5 id="常用框架"><a href="#常用框架" class="headerlink" title="常用框架"></a>常用框架</h5><p>TensorFlow、DeepLearning4J</p>
<h5 id="其他语言"><a href="#其他语言" class="headerlink" title="其他语言"></a>其他语言</h5><p>Groovy、Python、Go、NodeJs、Swift、Rust</p>
<h3 id="六、-推荐书籍"><a href="#六、-推荐书籍" class="headerlink" title="六、 推荐书籍"></a>六、 推荐书籍</h3><p>《深入理解 Java 虚拟机》 《 Effective Java 》 《深入分析 Java Web 技术内幕》 《大型网站技术架构》 《代码整洁之道》 《 Head First 设计模式》 《 maven 实战》 《区块链原理、设计与应用》 《 Java 并发编程实战》 《鸟哥的 Linux 私房菜》 《从 Paxos 到 Zookeeper 》 《架构即未来》</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/06/01/Guava初探/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="leonyoung">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://res.cloudinary.com/leon824/image/upload/v1505793001/IMG_3957_uwrsum.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="花谢花开">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/01/Guava初探/" itemprop="url">Guava Cache初探</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              
              <time title="創建於" itemprop="dateCreated datePublished" datetime="2018-06-01T15:22:37+08:00">
                2018-06-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字數統計&#58;</span>
                
                <span title="字數統計">
                  1,695
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">閱讀時長 &asymp;</span>
                
                <span title="閱讀時長">
                  7
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="缓存的类别、应用场景"><a href="#缓存的类别、应用场景" class="headerlink" title="缓存的类别、应用场景"></a>缓存的类别、应用场景</h3><blockquote>
<p>&emsp;&emsp;高速缓存简称缓存，原始意义是指访问速度比一般随机存取存储器（RAM）快的一种RAM，通常它不像系统主存那样使用<code>DRAM</code>技术，而使用昂贵但较快速的<code>SRAM</code>技术。当<code>CPU</code>处理数据时，它会先到<code>Cache</code>中去寻找，如果数据因之前的操作已经读取而被暂存其中，就不需要再从随机存取存储器（Main memory）中读取数据——由于<code>CPU</code>的运行速度一般比主内存的读取速度快，主存储器周期（访问主存储器所需要的时间）为数个时钟周期。因此若要访问主内存的话，就必须等待数个<code>CPU</code>周期从而造成浪费。</p>
<p>&emsp;&emsp; 现在的缓存概念不仅仅是<code>CPU</code>和主存之间有<code>Cache</code>，而且在内存和硬盘之间也有缓存（<strong>磁盘缓存</strong>），乃至在硬盘与网络之间也有某种意义上的<code>Cache</code>──称为<code>Internet</code>临时文件夹或网络内容缓存等。凡是位于速度相差较大的两种硬件之间，用于协调两者数据传输速度差异的结构，均可称之为<code>Cache</code>。</p>
</blockquote>
<p>摘录自<a href="https://zh.wikipedia.org/wiki/%E7%BC%93%E5%AD%98" target="_blank" rel="external">维基百科</a></p>
<p>&emsp;&emsp;在这里我们讨论的是磁盘缓存，当我们在实际开发中遇到查询远远比更新、插入操作更多的时候就可以考虑使用缓存，用空间来换取时间的策略。</p>
<h4 id="JVM缓存"><a href="#JVM缓存" class="headerlink" title="JVM缓存"></a>JVM缓存</h4><p>我们平常使用的<code>Map</code>、<code>List</code>都属于<code>JVM</code>缓存，使用<code>JVM</code>缓存的优势在于简单，但是也存在一些问题</p>
<ul>
<li>只能显式的写入、清理数据</li>
<li>不能按照一定的规则淘汰数据，如（<code>LRU</code>）、先进先出算法（<code>FIFO</code>）、最近最少使用算法（<code>LFU</code>）、非最近使用算法（<code>NMRU</code>）</li>
</ul>
<p>而本文提到的<code>Guava Cache</code>有如下的优势：</p>
<ul>
<li>当缓存的数据已经超过预先设置的最大值时，使用<code>LRU</code>算法移除一些数据;<br>由于<code>GuavaCahce</code>是基于<code>JVM</code>的缓存方式，所以它缓存的大小对于我们自己应用的本身有很大的影响，所以在必要的时候需要对它进行部分控制和淘汰，在<code>Guava</code>中采用<code>LRU</code>算法。</li>
<li><p>具备根据<code>entry</code>节点上次被访问或者写入的时间来计算过期机制；<br>例如在初始化<code>loadingCache</code>对象的时候我们可以指定写入的节点经过多长时间没有更新操作，就会被淘汰（<code>expireAfterWrite</code>）</p>
</li>
<li><p>缓存的key被封装在<code>WeakReference</code>引用内;<br>同样为了让缓存不会影响到自己的应用，<code>Guava</code>引入了软、弱引用；当缓存太大，或者缓存在GC的时候无法被回收掉，这个时候可以直接将这部分数据回收掉。</p>
</li>
<li><p>移除entry节点，可以触发监听器通知事件；<br>一般在<code>Guava Cache</code>中删除<code>entry</code>对于我们是透明的，但是<code>Guava</code>为我们提供了<code>removeLinstener</code>，这样我们在删除<code>entry</code>的时候对我们可见。</p>
</li>
<li><p>统计缓存使用过程中命中率/异常率/未命中率等数据。</p>
</li>
</ul>
<p>&emsp;&emsp;&ensp;同时，<em>Guava Cache</em>和<em>ConcurrentHashMap</em> 的核心数据结构一致，实际上Guava的核心类LocalCache实现了ConcurrentMap，所以Guava Cache Cache和ConcurrentHashMap是有<strong>“一样的血统”</strong>，但是在具体功能上还有有一些区别，<em>ConcurrentHashMap</em> 会一致保存所有添加的元素，直到显式的移除，而<em>Guava Cache</em>则在创建对象的时候就需要设置自动回收元素的方式。</p>
<h4 id="分布式缓存"><a href="#分布式缓存" class="headerlink" title="分布式缓存"></a>分布式缓存</h4><p>上面的几种放缓方式都只能是在单节点中使用，而对于在分布式的环境下则需要使用<strong>Redis、Memcached</strong>这样的缓存中间件了。</p>
<h3 id="如何使用Guava-Cache"><a href="#如何使用Guava-Cache" class="headerlink" title="如何使用Guava Cache"></a>如何使用Guava Cache</h3><p>首先我们需要在pom文件加入相关的依赖</p>
<pre><code><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">         <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.guava<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">         <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>guava<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">         <span class="tag">&lt;<span class="name">version</span>&gt;</span>21.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">     <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
</code></pre><p>然后我们可以初始化一个LoadingCache对象</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">ul</span>&gt;</span></div><div class="line">         <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"item-0"</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"link1.html"</span>&gt;</span>first item<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></div><div class="line">         <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"item-1"</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"link2.html"</span>&gt;</span>second item<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></div><div class="line">         <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"item-inactive"</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"link3.html"</span>&gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"bold"</span>&gt;</span>third item<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></div><div class="line">         <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"item-1"</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"link4.html"</span>&gt;</span>fourth item<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></div><div class="line">         <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"item-0"</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"link5.html"</span>&gt;</span>fifth item<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></div><div class="line">     <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></div><div class="line"> <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">private LoadingCache&lt;String, String&gt; loadingCache ;</div><div class="line">private void init() throws InterruptedException &#123;</div><div class="line">        loadingCache = CacheBuilder.newBuilder()</div><div class="line">                // 若在2秒以内没有被更新就会expire</div><div class="line">                .expireAfterWrite(2, TimeUnit.SECONDS)</div><div class="line">                //当entries接近maximumSize的时候就会驱赶出一个最近最少用的entry</div><div class="line">                .maximumSize(1000)</div><div class="line">                .build(new CacheLoader&lt;String, String&gt;() &#123;</div><div class="line">                    @Override</div><div class="line">                    public String load(String key) &#123;</div><div class="line">                        return &quot;kobe&quot;;</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">        for (int i = 10; i &lt; 15; i++) &#123;</div><div class="line">            QUEUE.put(&quot;jordan&quot; + i);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">private void testCache() &#123;</div><div class="line">    try &#123;</div><div class="line">        TimeUnit.SECONDS.sleep(3);</div><div class="line">        logger.info(&quot;当前缓存值 : &#123;&#125;,缓存大小 : &#123;&#125;&quot;, loadingCache.get(KEY), loadingCache.size());</div><div class="line">        loadingCache.get(key);</div><div class="line">    &#125; catch (ExecutionException e ) &#123;</div><div class="line">        logger.error(&quot;Exception&quot;, e);</div><div class="line">    &#125; catch (InterruptedException e) &#123;</div><div class="line">        e.printStackTrace();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上边初始化是给定2秒钟内若没有被更新就失效，而我们调用<code>testCache</code>方法中先sleep了3秒，所以此时缓存中的值一定是失效都清除掉了。下面我们可以通过debug一步一步看看<code>loadingCache.get(key)</code>这个方法到底是怎样获取到对应的值的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function">V <span class="title">get</span><span class="params">(K key, CacheLoader&lt;? <span class="keyword">super</span> K, V&gt; loader)</span> <span class="keyword">throws</span> ExecutionException </span>&#123;</div><div class="line">   <span class="keyword">int</span> hash = hash(checkNotNull(key));</div><div class="line">   <span class="keyword">return</span> segmentFor(hash).get(key, hash, loader);</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>首先可以看到将key哈希一次，通过hash和<strong>segmentShift</strong>、<strong>segmentMask</strong>做位运算得到对应的下标。在这一点和<em>ConcurrentHashMap</em> 是一致的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="function">V <span class="title">get</span><span class="params">(K key, <span class="keyword">int</span> hash, CacheLoader&lt;? <span class="keyword">super</span> K, V&gt; loader)</span> <span class="keyword">throws</span> ExecutionException </span>&#123;</div><div class="line">      checkNotNull(key);</div><div class="line">      checkNotNull(loader);</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        <span class="keyword">if</span> (count != <span class="number">0</span>) &#123; <span class="comment">// read-volatile</span></div><div class="line">          <span class="comment">// don't call getLiveEntry, which would ignore loading values</span></div><div class="line">          ReferenceEntry&lt;K, V&gt; e = getEntry(key, hash);</div><div class="line">          <span class="keyword">if</span> (e != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">long</span> now = map.ticker.read();</div><div class="line">            <span class="comment">// 获取没有失效、过期的entry</span></div><div class="line">           V value = getLiveValue(e, now);</div><div class="line">            <span class="keyword">if</span> (value != <span class="keyword">null</span>) &#123;</div><div class="line">              recordRead(e, now);</div><div class="line">              statsCounter.recordHits(<span class="number">1</span>);</div><div class="line">              <span class="keyword">return</span> scheduleRefresh(e, key, hash, value, now, loader);</div><div class="line">            &#125;</div><div class="line">            ValueReference&lt;K, V&gt; valueReference = e.getValueReference();</div><div class="line">            <span class="keyword">if</span> (valueReference.isLoading()) &#123;</div><div class="line">              <span class="keyword">return</span> waitForLoadingValue(e, key, valueReference);</div><div class="line">            &#125;</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">       ...</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>在上面方法里边比较关键的是<em>V value = getLiveValue(e, now);</em>这行，去获取仍然有效的value，继续追踪</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function">V <span class="title">getLiveValue</span><span class="params">(ReferenceEntry&lt;K, V&gt; entry, <span class="keyword">long</span> now)</span> </span>&#123;</div><div class="line">      <span class="keyword">if</span> (entry.getKey() == <span class="keyword">null</span>) &#123;</div><div class="line">        tryDrainReferenceQueues();</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">      &#125;</div><div class="line">      V value = entry.getValueReference().get();</div><div class="line">      <span class="keyword">if</span> (value == <span class="keyword">null</span>) &#123;</div><div class="line">        tryDrainReferenceQueues();</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">if</span> (map.isExpired(entry, now)) &#123;</div><div class="line">        tryExpireEntries(now);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">return</span> value;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>从<em>if (map.isExpired(entry, now))</em>这行可以看到是否过期是通过时间来判断的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">boolean isExpired(ReferenceEntry&lt;K, V&gt; entry, long now) &#123;</div><div class="line">    checkNotNull(entry);</div><div class="line">    if (expiresAfterAccess() &amp;&amp; (now - entry.getAccessTime() &gt;= expireAfterAccessNanos)) &#123;</div><div class="line">      return true;</div><div class="line">    &#125;</div><div class="line">    if (expiresAfterWrite() &amp;&amp; (now - entry.getWriteTime() &gt;= expireAfterWriteNanos)) &#123;</div><div class="line">      return true;</div><div class="line">    &#125;</div><div class="line">    return false;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<h3 id="建造者模式"><a href="#建造者模式" class="headerlink" title="建造者模式"></a>建造者模式</h3><p>上边我们在初始化loadingCache对象时，自主选择性的初始化了自己的参数。采用建造者模式赋予的灵活性对于初始化参数较多、自定义程度高的对象时一个很好的选择。 guava cache为我们提供了下面这些初始化方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> CacheBuilder&lt;K, V&gt; <span class="title">maximumSize</span><span class="params">(<span class="keyword">long</span> size)</span></span></div><div class="line"><span class="function"><span class="keyword">public</span> CacheBuilder&lt;K, V&gt; <span class="title">initialCapacity</span><span class="params">(<span class="keyword">int</span> initialCapacity)</span></span></div><div class="line"><span class="function"><span class="keyword">public</span> CacheBuilder&lt;K, V&gt; <span class="title">maximumWeight</span><span class="params">(<span class="keyword">long</span> weight)</span></span></div><div class="line"><span class="function"><span class="keyword">public</span> CacheBuilder&lt;K, V&gt; <span class="title">refreshAfterWrite</span><span class="params">(<span class="keyword">long</span> duration, TimeUnit unit)</span></span></div><div class="line"><span class="function">CacheBuilder&lt;K, V&gt; <span class="title">setValueStrength</span><span class="params">(Strength strength)</span></span></div><div class="line"><span class="function"><span class="keyword">public</span> CacheBuilder&lt;K, V&gt; <span class="title">softValues</span><span class="params">()</span></span></div><div class="line"><span class="function">	....</span></div></pre></td></tr></table></figure>
<p>参考：</p>
<p><a href="https://crossoverjie.top/2018/06/13/guava/guava-cache/" target="_blank" rel="external">Guava 源码分析（Cache 原理）</a></p>
<p><a href="https://www.jianshu.com/p/2502e8301ec7" target="_blank" rel="external">guava Cache源码分析（二）</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/01/如何在ubuntu16.04中搭建redis集群/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="leonyoung">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://res.cloudinary.com/leon824/image/upload/v1505793001/IMG_3957_uwrsum.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="花谢花开">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/01/如何在ubuntu16.04中搭建redis集群/" itemprop="url">如何在ubuntu16.04中搭建redis集群</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              
              <time title="創建於" itemprop="dateCreated datePublished" datetime="2018-04-01T13:22:47+08:00">
                2018-04-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/中间件/" itemprop="url" rel="index">
                    <span itemprop="name">中间件</span>
                  </a>
                </span>

                
                
              
            </span>
          

          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字數統計&#58;</span>
                
                <span title="字數統計">
                  1,293
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">閱讀時長 &asymp;</span>
                
                <span title="閱讀時長">
                  7
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="如何在ubuntu16-04中搭建redis集群"><a href="#如何在ubuntu16-04中搭建redis集群" class="headerlink" title="如何在ubuntu16.04中搭建redis集群"></a>如何在ubuntu16.04中搭建redis集群</h2><blockquote>
<p>要想搭建一个最简单的Redis集群，那么至少需要6个节点：3个Master和3个Slave。</p>
<h3 id="在ubuntu16-04中安装redis"><a href="#在ubuntu16-04中安装redis" class="headerlink" title="在ubuntu16.04中安装redis"></a>在ubuntu16.04中安装redis</h3></blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">//下载</div><div class="line">axel -n 5 http://download.redis.io/releases/redis-4.0.9.tar.gz</div><div class="line"></div><div class="line">//解压</div><div class="line">tar -zxvf redis-4.0.9.tar.gz</div><div class="line"></div><div class="line">编译</div><div class="line">make</div><div class="line"></div><div class="line">//为了方便启动redis，在profile中添加PATH</div><div class="line"><span class="meta">#</span>SET REDIS_HOME</div><div class="line">export REDIS_HOME=/opt/local/software/redis-4.0.9</div><div class="line">export PATH=$PATH:$REDIS_HOME/src</div></pre></td></tr></table></figure>
<p>然后尝试启动redis检查是否安装成功，若出现下面的内容说明安装成功。</p>
<p><img src="http://res.cloudinary.com/leon824/image/upload/v1522566992/redis1_cklmlm.png" width="100%" height="100%"></p>
<h3 id="配置redis集群"><a href="#配置redis集群" class="headerlink" title="配置redis集群"></a>配置redis集群</h3><p>由于电脑配置有限，不大可能安装那么多虚拟机。可以在一台虚拟机中开启多个redis实例，将这多个实例组建成一个redis集群。首先创建六个文件夹，将redis-conf文件copy到每一个文件夹中。</p>
<p><img src="http://res.cloudinary.com/leon824/image/upload/v1522566990/redis2_yejm3q.png" width="100%" height="60%"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">cp ../redis-4.0.9/redis.conf ./8001</div><div class="line">cp ../redis-4.0.9/redis.conf ./8002</div><div class="line">cp ../redis-4.0.9/redis.conf ./8003</div><div class="line">cp ../redis-4.0.9/redis.conf ./8004</div><div class="line">cp ../redis-4.0.9/redis.conf ./8005</div><div class="line">cp ../redis-4.0.9/redis.conf ./8006</div></pre></td></tr></table></figure>
<h4 id="redis配置文件"><a href="#redis配置文件" class="headerlink" title="redis配置文件"></a>redis配置文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"># redis 提供服务时绑定的本机网络地址，可以是多个满足多块网卡分别对外网内网的访问, 按需要改</div><div class="line">bind 127.0.0.1</div><div class="line"># 提供服务的端口, 供客户端连接</div><div class="line">port 8001</div><div class="line"># 启动redis服务时,进程pid存储位置</div><div class="line">pidfile /opt/local/software/redis-node/8001/redis.pid</div><div class="line"># redis 日志文件所在</div><div class="line">logfile &quot;/opt/local/software/redis-node/8001/log.txt&quot;</div><div class="line"># 持久化文件存储目录</div><div class="line">dir /opt/local/software/redis-node/8001</div><div class="line"># 开启集群模式</div><div class="line">cluster-enabled yes</div><div class="line"># 集群模式下的节点配置信息</div><div class="line">cluster-config-file nodes.conf</div><div class="line"># 集群中各节点间连接超时时间</div><div class="line">cluster-node-timeout 5000</div><div class="line"># 允许数据持久化追加</div><div class="line">appendonly yes</div></pre></td></tr></table></figure>
<p>然后根据上面的配置文件将每一个redis实例的端口号、目录、日志文件等等按照具体的情况设置。</p>
<h4 id="启动redis"><a href="#启动redis" class="headerlink" title="启动redis"></a>启动redis</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">redis-server 8001/redis.conf</div><div class="line">redis-server 8002/redis.conf</div><div class="line">redis-server 8003/redis.conf</div><div class="line">redis-server 8004/redis.conf</div><div class="line">redis-server 8005/redis.conf</div><div class="line">redis-server 8006/redis.conf</div></pre></td></tr></table></figure>
<p>启动完成之后先查看一下各个节点是否启动成功</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">leon at leon_ubuntu in /opt/local/software/redis-node </div><div class="line">$ ps aux | grep redis</div><div class="line">leon      15499  0.0  0.1  50908  5580 pts/19   Sl+  14:22   0:02 redis-server 127.0.0.1:8001 [cluster]</div><div class="line">leon      15506  0.0  0.1  50908  5580 pts/4    Sl+  14:22   0:02 redis-server 127.0.0.1:8002 [cluster]</div><div class="line">leon      15511  0.0  0.1  50908  5536 pts/18   Sl+  14:23   0:02 redis-server 127.0.0.1:8003 [cluster]</div><div class="line">leon      15516  0.0  0.1  50908  5320 pts/21   Sl+  14:23   0:02 redis-server 127.0.0.1:8004 [cluster]</div><div class="line">leon      15521  0.0  0.1  50908  5436 pts/20   Sl+  14:23   0:02 redis-server 127.0.0.1:8005 [cluster]</div><div class="line">leon      15526  0.0  0.1  50908  5464 pts/22   Sl+  14:23   0:02 redis-server 127.0.0.1:8006 [cluster]</div><div class="line">leon      15536  0.0  0.0  14352  2624 pts/23   S+   14:23   0:00 redis-cli -c -p 8001</div><div class="line">leon      15886  0.0  0.0  14224   936 pts/25   S+   15:05   0:00 grep --color=auto --exclude-dir=.bzr --exclude-dir=CVS --exclude-dir=.git --exclude-dir=.hg --exclude-dir=.svn redis</div></pre></td></tr></table></figure>
<p>上面的几个节点都已经启动成功了，但是并没有组建成为集群，要想组建一个集群还需要使用redis-trib.rb工具将上面六个节点连接起来。但是它需要在ruby的环境下运行并且在这个环境下安装对应的redis插件。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo gem install redis</div></pre></td></tr></table></figure></p>
<p>安装完成之后执行下面的指令将redis实例组建成一个集群<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">redis-trib.rb create --replicas 1 127.0.0.1:8001 127.0.0.1:8002 127.0.0.1:8003 127.0.0.1:8004 127.0.0.1:8005 127.0.0.1:8006</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line">leon at leon_ubuntu in /opt/local/software/redis-4.0.9/src </div><div class="line">$ redis-trib.rb create --replicas 1 127.0.0.1:8001 127.0.0.1:8002 127.0.0.1:8003 127.0.0.1:8004 127.0.0.1:8005 127.0.0.1:8006</div><div class="line">&gt;&gt;&gt; Creating cluster</div><div class="line">&gt;&gt;&gt; Performing hash slots allocation on 6 nodes...</div><div class="line">Using 3 masters:</div><div class="line">127.0.0.1:8001</div><div class="line">127.0.0.1:8002</div><div class="line">127.0.0.1:8003</div><div class="line">Adding replica 127.0.0.1:8005 to 127.0.0.1:8001</div><div class="line">Adding replica 127.0.0.1:8006 to 127.0.0.1:8002</div><div class="line">Adding replica 127.0.0.1:8004 to 127.0.0.1:8003</div><div class="line">&gt;&gt;&gt; Trying to optimize slaves allocation for anti-affinity</div><div class="line">[WARNING] Some slaves are in the same host as their master</div><div class="line">M: 1bc512b4d4b5d0c73a72d97e7d70ea307db7ae96 127.0.0.1:8001</div><div class="line">   slots:0-5460 (5461 slots) master</div><div class="line">M: b9b6ff12c2a788a708a5fc754ee6e9add83ef089 127.0.0.1:8002</div><div class="line">   slots:5461-10922 (5462 slots) master</div><div class="line">M: 01742676bd6bb86313c44365df28328a383a007f 127.0.0.1:8003</div><div class="line">   slots:10923-16383 (5461 slots) master</div><div class="line">S: 5d3d629269a52017f0e1fb5d043f5797319aa306 127.0.0.1:8004</div><div class="line">   replicates 1bc512b4d4b5d0c73a72d97e7d70ea307db7ae96</div><div class="line">S: ab65c3dd627b885d60e7f01d69acc7fbd1db50b0 127.0.0.1:8005</div><div class="line">   replicates b9b6ff12c2a788a708a5fc754ee6e9add83ef089</div><div class="line">S: 2487d2d01333914e7d407a7fe89ddfa2f12884a9 127.0.0.1:8006</div><div class="line">   replicates 01742676bd6bb86313c44365df28328a383a007f</div><div class="line">Can I set the above configuration? (type &apos;yes&apos; to accept): yes</div><div class="line">&gt;&gt;&gt; Nodes configuration updated</div><div class="line">&gt;&gt;&gt; Assign a different config epoch to each node</div><div class="line">&gt;&gt;&gt; Sending CLUSTER MEET messages to join the cluster</div><div class="line">Waiting for the cluster to join..</div><div class="line">&gt;&gt;&gt; Performing Cluster Check (using node 127.0.0.1:8001)</div><div class="line">M: 1bc512b4d4b5d0c73a72d97e7d70ea307db7ae96 127.0.0.1:8001</div><div class="line">   slots:0-5460 (5461 slots) master</div><div class="line">   1 additional replica(s)</div><div class="line">M: b9b6ff12c2a788a708a5fc754ee6e9add83ef089 127.0.0.1:8002</div><div class="line">   slots:5461-10922 (5462 slots) master</div><div class="line">   1 additional replica(s)</div><div class="line">S: 2487d2d01333914e7d407a7fe89ddfa2f12884a9 127.0.0.1:8006</div><div class="line">   slots: (0 slots) slave</div><div class="line">   replicates 01742676bd6bb86313c44365df28328a383a007f</div><div class="line">S: 5d3d629269a52017f0e1fb5d043f5797319aa306 127.0.0.1:8004</div><div class="line">   slots: (0 slots) slave</div><div class="line">   replicates 1bc512b4d4b5d0c73a72d97e7d70ea307db7ae96</div><div class="line">M: 01742676bd6bb86313c44365df28328a383a007f 127.0.0.1:8003</div><div class="line">   slots:10923-16383 (5461 slots) master</div><div class="line">   1 additional replica(s)</div><div class="line">S: ab65c3dd627b885d60e7f01d69acc7fbd1db50b0 127.0.0.1:8005</div><div class="line">   slots: (0 slots) slave</div><div class="line">   replicates b9b6ff12c2a788a708a5fc754ee6e9add83ef089</div><div class="line">[OK] All nodes agree about slots configuration.</div><div class="line">&gt;&gt;&gt; Check for open slots...</div><div class="line">&gt;&gt;&gt; Check slots coverage...</div><div class="line">[OK] All 16384 slots covered.</div></pre></td></tr></table></figure>
<p>上面的日志打印看出已经成功将6个节点全部组建成一个redis集群了，同时将[8001,8002,8003]作为master，[8004，8005，8006]为前面三个的复制节点。</p>
<p>至此redis集群搭建完成。</p>
<p>参考：</p>
<p><a href="https://www.jianshu.com/p/0dc64585a2a9" target="_blank" rel="external">ubuntu安装redis集群
</a></p>
<p><a href="https://www.howtoing.com/how-to-configure-a-redis-cluster-on-ubuntu-14-04" target="_blank" rel="external">如何在Ubuntu 14.04配置的Redis集群</a></p>
<p><a href="https://www.linuxidc.com/Linux/2017-03/141683.htm" target="_blank" rel="external">Linux下Redis集群安装部署及使用详解</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/03/17/浅析java语言中锁机制/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="leonyoung">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://res.cloudinary.com/leon824/image/upload/v1505793001/IMG_3957_uwrsum.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="花谢花开">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/17/浅析java语言中锁机制/" itemprop="url">浅析java语言中锁机制</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              
              <time title="創建於" itemprop="dateCreated datePublished" datetime="2018-03-17T15:24:47+08:00">
                2018-03-17
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字數統計&#58;</span>
                
                <span title="字數統計">
                  3,559
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">閱讀時長 &asymp;</span>
                
                <span title="閱讀時長">
                  12
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="浅析java语言中锁机制"><a href="#浅析java语言中锁机制" class="headerlink" title="浅析java语言中锁机制"></a>浅析java语言中锁机制</h1><blockquote>
<p>&emsp;&emsp;多任务并发已经是计算机中不可缺少的一部分了，很多时候让计算机同一时刻做几件事，不仅仅是因为运算能力提高了，还有一个重要原因就是<code>cpu</code>的运算速度和存储、通信子系统速度差异太大。所以不得不“压榨”运算能力。<br> 而压榨运算能力就不得不用到多线程，在单线程的情况下运算环境较为简单，而到了多线程情况下则会产生很多意想不到的结果。要保证在多线程的情况下各个线程“相安无事”的运行，则必须用到锁机制。</p>
</blockquote>
<h2 id="java内存模型"><a href="#java内存模型" class="headerlink" title="java内存模型"></a>java内存模型</h2><p>在讲锁机制之前，我们必须先了解<code>jvm</code>的内存模型。 模型图如下</p>
<p><img src="https://res.cloudinary.com/leon824/image/upload/v1536114662/pic93_wxozba.png" width="90%" height="90%"></p>
<p>&emsp;&emsp;java线程读写数据是直接读写工作内存中的数据，工作内存可能并非是物理内存，为了性能很大可能是高速缓存和寄存器。线程间通信必须通过内内存来实现。假设初始值x = 0， 然后线程A将x值修改为1， 那么B要知道此时A修改过后的值就必须是A线程先将值从工作内存中写入到主内存，然后线程B再从主内存中读取x的值，如此完成线程间的通信–共享内存的方式。</p>
<p>JVM内存模型围绕三个点进行： 原子性、可见性、有序性。</p>
<p>原子性：不可分割，java中的基本类型的读写基本可以认为是原子操作，如果要在更大范围内保证原子性，可以是用<code>synchronized</code>来保证原子性。</p>
<p>可见性：当一个线程修改共享变量的值，其他线程能够立即得知这个变化。<code>volatile</code>、<code>synchronized</code>、<code>final</code>都能够保证内存可见性。<code>volatile</code>能够保证一个被修改之后立即同步到主内存中，然后其他线程使用到被<code>volatile</code>修饰的变量时，必须先从主内存中同步到工作内存中。<code>synchronized</code>保证可见性是一个线程<code>unlock</code>时，必须将修改的值同步到主内存中，下一个获取到lock的线程必须先同步主内存数据，从而保证可见性。</p>
<p>有序性：如果在本线程内观察，所有操作都是有序的；如果在另外一个线程中观察另一个线程，所有操作都是无序的。 前面半句意思是在同一个线程内表现为串行的语义，后半句是“指令重排序”现象和“工作内存与主内存之间延迟”现象。</p>
<p>先行发生：指的是如果A先行发生于B，那么操作A的影响能够被操作B观察到，“影响”包括修改了共享内存变量的值、发送的消息、调用方法等。由于优化重排序的原因，操作之间的时间上先后执行和“先行发生”并没有关系。</p>
<h2 id="volatile"><a href="#volatile" class="headerlink" title="volatile"></a>volatile</h2><p>  需要注意的是volatile并不是锁，它是jvm提供的最轻量级的同步机制。大多数人对volatile的原理和使用并不清楚。volatile主要具备两个特性：</p>
<ul>
<li>保证内存可见性</li>
<li>禁止指令重排序 </li>
</ul>
<h3 id="内存可见性"><a href="#内存可见性" class="headerlink" title="内存可见性"></a>内存可见性</h3><p>&emsp;&emsp;被<code>volatile</code>修饰的变量，被线程修改之后会立即从工作内存中同步到主内存中，线程若要读被volatile修饰的变量则必须先从主内存中同步最新的值，这样就保证了线程之间变量的同步。但是线程之间变量的值并非立即同步的，各个线程之间的值可能存在不一致的情况，但是由于每一次读的时候都从主内存中更新，因此也不认为存有不一致的情况。</p>
<p>但是由于volatile只能保证可见性，并不保证原子性，所以在不符合下面的两种情况还是需要通过<strong>加锁</strong>来保证原子性。</p>
<ul>
<li><p>运算结果并不依赖当前值</p>
<p>  例如： a++ 、 b += 3</p>
</li>
<li><p>变量不需要参加其他状态变量共同参与不变约束。</p>
<p>   例如： low &lt; up</p>
</li>
</ul>
<h3 id="禁止指令重排序"><a href="#禁止指令重排序" class="headerlink" title="禁止指令重排序"></a>禁止指令重排序</h3><p> &emsp;&emsp;现代cpu为了提高执行效率，一个指令的执行被分成：取指、译码、访存、执行、写回、等若干个阶段。然后，多条指令可以同时存在于流水线中，同时被执行。但是无论怎样重排序必须要满足<code>as-if-serial</code>语义，这也是为什么我们在单线程的情况下编程并不需要考虑代码执行顺序的问题，因为无论怎样排序，最后执行的结果总是和顺序执行的结果一致。</p>
<p>&emsp;&emsp;&ensp; 禁止重排序时候通过内存屏障来实现的，即是说重排序时不能讲后面的指令重排序到内存屏障之前的位置。若只有一个cpu访问内存时并不需要内存屏障，若多个cpu访问内存时，并且一个正在观察另外一个时，就需要内存屏障来保证一致性。</p>
<p> &emsp;&emsp;&ensp; 下面摘自《深入理解Java虚拟机》：<br>  “观察加入<code>volatile</code>关键字和没有加入<code>volatile</code>关键字时所生成的汇编代码发现，加入<code>volatile</code>关键字时，会多出一个<code>lock</code>前缀指令”<br>lock前缀指令实际上相当于一个内存屏障（也成内存栅栏），内存屏障会提供3个功能：</p>
<ul>
<li><p>1、它确保指令重排序时不会把其后面的指令排到内存屏障之前的位置，也不会把前面的指令排到内存屏障的后面；即在执行到内存屏障这句指令时，在它前面的操作已经全部完成；</p>
</li>
<li><p>2）它会强制将对缓存的修改操作立即写入主存；</p>
</li>
<li><p>3）如果是写操作，它会导致其他CPU中对应的缓存行无效。</p>
</li>
</ul>
<h2 id="synchronized"><a href="#synchronized" class="headerlink" title="synchronized"></a>synchronized</h2><blockquote>
<p>synchronized是我们最常使用的加锁方式，也是官方推荐的方式。</p>
</blockquote>
<p>&emsp;&emsp;<code>synchronized</code>最常用的互斥有段，<code>synchronized</code>经过编译之后，会在同步块前后分别形成<code>monitorenter</code>和<code>monitorexit</code>两个字节码指令。这两个指令都需要明确指定一个引用类型的对象参数来确定需要锁定和解锁的对象。</p>
<p>&emsp;&emsp;&ensp; 根据虚拟机的规范要求，在执行<em>monitorenter</em>指令时，首先要尝试获取对象的锁，如果对象没有被锁定，或者当前线程已经拥有那个对象的锁，把锁的计数器加1，相应的，如果执行<em>monitorexit</em>指令就会将锁计数器减1，当计数器为0时，锁就被释放。如果获取对象锁失败，那么当前线程就要一直阻塞等待，直到对象锁被另外一个线程释放为止。同时<code>Synchronized</code>锁是可重入的，假设对象<code>person</code>有两个被<code>Synchronized</code>修饰的同步方法M、N，当线程执行完M之后还可以接着执行N，所以这在一定程度上避免了死锁，</p>
<p>如何保证可见性？</p>
<p>&emsp;&emsp;&ensp; 当一个线程释放锁的时候，将自己修改的数据从工作内存更新到主内存中，获取锁那个线程也会先将主内存中的数据同步到主机的工作内存中，如此就保证了<strong>内存可见性</strong>。</p>
<h2 id="ReentrantLock"><a href="#ReentrantLock" class="headerlink" title="ReentrantLock"></a>ReentrantLock</h2><blockquote>
<p> <code>ReentrantLock</code> 类实现了<code>Lock</code>，它拥有与 <code>synchronized</code>相同的并发性和内存语义，但是添加了类似公平锁、轮询锁、定时锁等候和可中断锁等候的一些特性。此外，它还提供了在激烈争用情况下更佳的性能。</p>
</blockquote>
<p>&emsp;&emsp;&ensp; 但相比<code>synchronized</code>锁来说，<code>Lock</code>锁使用需要手动获取、手动释放。我们在创建<code>Lock</code>实例的时候可以指定使用公平锁还是非公平锁，非公平锁性能会更好一下(公平锁需要维护公平所需要的记账和同步)，所以我们通常时候时都是用非公平锁。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">ReentrantLock</span><span class="params">(<span class="keyword">boolean</span> fair)</span> </span>&#123;</div><div class="line">       sync = fair ? <span class="keyword">new</span> FairSync() : <span class="keyword">new</span> NonfairSync();</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>这里<code>FairSync</code>和<code>NonfairSync</code>都继承了<code>Sync</code>。而公平锁和非公平锁的区别在于获取锁的方式。<br>非公平锁：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> </span>&#123;</div><div class="line">				<span class="comment">// 先判断此时锁是否有其他线程持有，没有的话通过CAS更新锁状态</span></div><div class="line">            <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, <span class="number">1</span>)) </div><div class="line">                setExclusiveOwnerThread(Thread.currentThread());</div><div class="line">            <span class="keyword">else</span></div><div class="line">                acquire(<span class="number">1</span>);</div><div class="line">        &#125;</div></pre></td></tr></table></figure>
<h2 id="自旋锁"><a href="#自旋锁" class="headerlink" title="自旋锁"></a>自旋锁</h2><blockquote>
<p>Java的线程是映射到操作系统的原生线程之上的，如果要阻塞或唤醒一个线程，都需要操作系统来帮忙完成，这就需要从用户态转换到核心态中，因此状态装换需要耗费很多的处理器时间，对于代码简单的同步块状态转换消耗的时间有可能比用户代码执行的时间还要长。</p>
</blockquote>
<p>&emsp;&emsp;&ensp; 那么就可以采用自旋锁的方式，假设这个时候有A线程持有锁，B线程等待锁，若是A线程持有锁的时间并不长，那么这个时候B线程不会被阻塞而是采用“忙等”的方式等待锁被释放。从而避免了操作系统切换用户态、内核态的消耗。</p>
<h3 id="带来的问题："><a href="#带来的问题：" class="headerlink" title="带来的问题："></a>带来的问题：</h3><p>1、可能占用太多cpu资源：</p>
<p>&emsp;&emsp;&ensp; 若是A线程在短时间内并不释放锁，那么这种方式可能占用太多cpu时间，导致cpu资源浪费。因此jvm有一个默认自旋次数限制（默认是10次，可以使用-XX:PreBlockSpin来更改），若还是没有获取到锁，那就应该使用传统的方式去挂起线程了。</p>
<p>2、死锁问题<br> &emsp;&emsp;&ensp; 假设有有一个线程运行在一个处理器上， 而另外一个线程想获取这个处理器的锁， 那么他将一直持有这个cpu进行自旋操作，你的线程代码则永远无法获得机会释放锁，于是陷入死锁。</p>
<h3 id="自适应自旋"><a href="#自适应自旋" class="headerlink" title="自适应自旋"></a>自适应自旋</h3><p>&emsp;&emsp;&ensp;  在jdk1.6中引入了自适应的自旋锁。自适应意味着自旋的时间不在固定了，而是由前一次在同一个锁上的自旋时间及锁的拥有者的状态来实现。如果在同一个锁对象刚刚成功获取到了锁，并且持有锁的线程正在运行中，那么<code>jvm</code>久认为这次也能够获取成功，那么久可能多尝试几次来获取，比方说50次。若是对于某一个锁，自适应锁很少成功过，那么<code>jvm</code>可能就忽略掉自旋的过程而直接挂起。</p>
<h2 id="锁消除"><a href="#锁消除" class="headerlink" title="锁消除"></a>锁消除</h2><blockquote>
<p>锁消除是Java虚拟机在<code>JIT</code>编译是，通过对运行上下文的扫描，去除不可能存在共享资源竞争的锁，通过锁消除，可以节省毫无意义的请求锁时间。</p>
</blockquote>
<p>&emsp;&emsp;&ensp; 在动态编译同步块的时候，JIT编译器可以借助一种被称为逃逸分析（Escape Analysis）的技术来判断同步块所使用的锁对象是否只能够被一个线程访问而没有被发布到其他线程。如果同步块所使用的锁对象通过这种分析被证实只能够被一个线程访问，那么JIT编译器在编译这个同步块的时候并不生成<code>synchronized</code>所表示的锁的申请与释放对应的机器码，而仅生成原临界区代码对应的机器码，这就造成了被动态编译的字节码就像是不包含<code>monitorenter</code>（申请锁）和<code>monitorexit</code>（释放锁）这两个字节码指令一样，即消除了锁的使用。这种编译器优化就被称为锁消除（<code>Lock Elision</code>），它使得特定情况下我们可以完全消除锁的开销。</p>
<p>示意图：</p>
<p><img src="http://res.cloudinary.com/leon824/image/upload/v1517466723/jvmsuo_ber7ev.png" width="100%" height="100%"></p>
<h2 id="锁粗化"><a href="#锁粗化" class="headerlink" title="锁粗化"></a>锁粗化</h2><blockquote>
<p>锁粗化（Lock Coarsening/Lock Merging）是JIT编译器对内部锁的具体实现所做的一种优化。</p>
</blockquote>
<p>&emsp;&emsp;一般来说，我们加锁会尽量锁住更小的代码块， 这样使得需要同步的操作数量尽可能小，如果存在竞争那么也能尽快拿到锁。在通常情况下这都是正确的，但是如果反复对同一个对象加锁，甚至加锁操作出现在了循环体中，频繁的进行互斥操作也会导致不必要的性能损耗。<br>如果虚拟机探测到有这样的情况的话，会把加锁同步的范围扩展到整个操作序列的外部，这样的一个锁范围扩展的操作就称之为锁粗化。</p>
<h2 id="偏向锁"><a href="#偏向锁" class="headerlink" title="偏向锁"></a>偏向锁</h2><blockquote>
<p>它的目的是消除数据在无竞争情况下的同步原语，进一步提高程序性能。如果说轻量级锁是在无竞争的情况下使用<code>CAS</code>操作去消除同步使用的互斥量，那偏向锁就是在无竞争的情况下把整个同步都消除掉，连CAS都不做。</p>
</blockquote>
<p>&emsp;&emsp;偏向锁会偏向于第一个获得它的线程，如果在接下来的执行过程中，该锁没有被其他的线程获取，则持有偏向锁的线程将永远不需要同步。大多数情况下，锁不仅不存在多线程竞争，而且总是由同一线程多次获得，为了让线程获得锁的代价更低而引入了偏向锁。</p>
<p>&emsp;&emsp;当锁对象第一次被线程获取的时候，线程使用<code>CAS</code>操作把这个锁的线程<code>ID</code>记录再对象<code>Mark Word</code>之中，同时置偏向标志位1。以后该线程在进入和退出同步块时不需要进行<code>CAS</code>操作来加锁和解锁，只需要简单地测试一下对象头的<code>Mark Word</code>里是否存储着指向当前线程的偏向锁。如果测试成功，表示线程已经获得了锁</p>
<p>参考：</p>
<p>-《深入理解java虚拟机》</p>
<p><a href="http://blog.csdn.net/u013256816/article/details/51008443" target="_blank" rel="external">http://blog.csdn.net/u013256816/article/details/51008443</a></p>
<p><a href="https://segmentfault.com/a/1190000009828216" target="_blank" rel="external">https://segmentfault.com/a/1190000009828216</a></p>
<p><a href="https://www.jianshu.com/p/dfbe0ebfec95" target="_blank" rel="external">https://www.jianshu.com/p/dfbe0ebfec95</a></p>
<p><a href="http://www.importnew.com/19472.html" target="_blank" rel="external">http://www.importnew.com/19472.html</a></p>
<p><a href="http://traxexer.iteye.com/blog/1846344" target="_blank" rel="external">http://traxexer.iteye.com/blog/1846344</a></p>
<p><a href="http://www.broadview.com.cn/article/789" target="_blank" rel="external">http://www.broadview.com.cn/article/789</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
      <div id="sidebar-dimmer"></div>
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="https://res.cloudinary.com/leon824/image/upload/v1505793001/IMG_3957_uwrsum.jpg"
                alt="leonyoung" />
            
              <p class="site-author-name" itemprop="name">leonyoung</p>
              <p class="site-description motion-element" itemprop="description">人们常常嘲笑“螳臂当车” 但有时候啊，你并不是驾车的人 正巧是那只，反抗不了的螳螂。</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">21</span>
                  <span class="site-state-item-name">文章</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                
                  <span class="site-state-item-count">11</span>
                  <span class="site-state-item-name">分類</span>
                
              </div>
            

            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">leonyoung</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Site words total count&#58;</span>
    
    <span title="Site words total count">29.1k</span>
  
</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主題 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>


<span id="busuanzi_container_site_pv">
    本站总访问量<span id="busuanzi_value_site_pv"></span>次
</span>



        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  





<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/src/love.js"></script>
</body>
</html>
